<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Subasta en Vivo</title>
    <style>
        body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; margin:0; padding:0; }
        h1 { margin:20px 0; }
        #ganadores, #participantes, #controles, #tiempoBox { margin: 20px; padding: 20px; border-radius: 10px; display: inline-block; vertical-align: top; }
        #ganadores { background: #2c3e50; width: 350px; height: 400px; overflow-y: auto; }
        #participantes { background: #27ae60; width: 350px; height: 400px; overflow-y: auto; }
        #controles { background: #8e44ad; width: 300px; }
        #tiempoBox { background: #e67e22; width: 300px; height: 120px; display:flex; flex-direction:column; justify-content:center; align-items:center; font-size:20px; font-weight:bold; margin-left: 20px; }
        #logDonaciones { background: #333; color: #ccc; width: 740px; height: 150px; overflow-y: auto; margin: 20px auto; padding: 10px; border-radius: 10px; text-align: left; font-family: monospace; }
        button { margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .start { background: green; color: white; }
        .stop { background: red; color: white; }
        ul { list-style: none; padding: 0; }
        li { margin: 5px 0; font-size: 18px; }
        .totales { margin-top: 10px; font-weight: bold; font-size: 16px; }
        h2 { background: rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 5px; display: inline-block; margin-bottom: 10px; font-size: 18px; }
    </style>
</head>
<body>
    <h1>⚡ Subasta en Vivo ⚡</h1>
    <div id="ganadores"><h2>🏆 Ganadores de Rondas</h2><ul id="listaGanadores"></ul></div>
    <div id="participantes"><h2>👥 Participantes (Ronda Actual)</h2><ul id="listaParticipantes"></ul><div class="totales">Total participantes: <span id="totalParticipantes">0</span></div><div class="totales">Diamantes donados: <span id="totalDiamantes">0</span></div></div>
    <div style="display: inline-block;">
        <div id="controles">
            <h2>🎮 Controles</h2>
            <label for="tiktokUser">👤 TikTok User:</label><br>
            <input type="text" id="tiktokUser" placeholder="@usuario" style="width: 90%; margin-bottom: 15px; padding: 5px;"><br>
            <div class="subcuadro">
                <label for="tiempo">⏱ Tiempo inicial (segundos):</label><br>
                <input type="number" id="tiempo" value="200"><br><br>
                <button class="start" onclick="iniciar()">Iniciar</button>
                <button onclick="pausar()">Pausar</button>
                <button class="stop" onclick="finalizar()">Finalizar</button>
                <button onclick="restart()">Restart</button>
            </div>
        </div>
        <div id="tiempoBox"><h2>⏳ Tiempo Restante</h2><div id="tiempoRestante" style="font-size: 2.5em;">0</div></div>
    </div>
    <div id="logDonaciones"><strong>📝 Historial de Eventos:</strong></div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        const socket = io("https://mi-app-subastas.onrender.com");

        const listaParticipantesEl = document.getElementById('listaParticipantes');
        const listaGanadoresEl = document.getElementById('listaGanadores');
        const totalParticipantesEl = document.getElementById('totalParticipantes');
        const totalDiamantesEl = document.getElementById('totalDiamantes');
        const logDonacionesEl = document.getElementById('logDonaciones');
        const tiempoRestanteEl = document.getElementById('tiempoRestante');
        
        let tiempoActual = 0;
        let intervalo = null;
        let participantes = [];
        let ganadoresHistorial = [];

        socket.on('connect', () => logDonacionesEl.innerHTML += `<p style="color: lightgreen;">✔️ Conectado al servidor.</p>`);
        socket.on('conexion_exitosa', (mensaje) => logDonacionesEl.innerHTML += `<p style="color: lightgreen;">✔️ ${mensaje}</p>`);
        socket.on('conexion_error', (error) => alert(error));
        
        socket.on('actualizar_lista', (nuevaListaParticipantes) => {
            participantes = nuevaListaParticipantes;
            actualizarParticipantesUI();
        });

        function iniciar() {
            logDonacionesEl.innerHTML += `<p style="color: yellow;">▶️ Iniciando nueva subasta...</p>`;
            socket.emit("iniciar_subasta"); 
            
            tiempoActual = parseInt(document.getElementById("tiempo").value);
            tiempoRestanteEl.textContent = tiempoActual;
            if (intervalo) clearInterval(intervalo);
            intervalo = setInterval(() => {
                if (tiempoActual > 0) {
                    tiempoActual--;
                    tiempoRestanteEl.textContent = tiempoActual;
                } else {
                    terminarTiempo();
                }
            }, 1000);
        }

        function terminarTiempo() {
            if (intervalo) { clearInterval(intervalo); intervalo = null; }
            socket.emit('finalizar_subasta');
            logDonacionesEl.innerHTML += `<p style="color: orange;">⏱️ ¡Tiempo terminado! La lista está congelada.</p>`;
        }
        
        function finalizar() {
             terminarTiempo();
             tiempoActual = 0;
             tiempoRestanteEl.textContent = 0;
             logDonacionesEl.innerHTML += `<p style="color: red;">⏹️ Ronda finalizada manualmente.</p>`;
             if (participantes.length > 0) {
                const ganador = participantes[0];
                ganadoresHistorial.unshift(ganador);
                logDonacionesEl.innerHTML += `<p style="color: gold;">🏆 ¡Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
                actualizarGanadoresUI();
             }
             participantes = [];
             actualizarParticipantesUI();
        }
        
        function restart() {
            terminarTiempo();
            participantes = [];
            ganadoresHistorial = [];
            actualizarParticipantesUI();
            actualizarGanadoresUI();
            logDonacionesEl.innerHTML = '<strong>📝 Historial de Eventos:</strong>';
        }

        function pausar() {
            if (intervalo) { clearInterval(intervalo); intervalo = null; }
        }

        function actualizarParticipantesUI() {
            listaParticipantesEl.innerHTML = "";
            let totalDiamantes = 0;
            participantes.forEach(p => {
                const li = document.createElement("li");
                li.textContent = `${p.usuario} - ${p.cantidad} 💎`;
                listaParticipantesEl.appendChild(li);
                totalDiamantes += p.cantidad;
            });
            totalParticipantesEl.textContent = participantes.length;
            totalDiamantesEl.textContent = totalDiamantes;
        }

        function actualizarGanadoresUI() {
            listaGanadoresEl.innerHTML = "";
            ganadoresHistorial.forEach(g => {
                const li = document.createElement('li');
                li.textContent = `🏆 ${g.usuario} - ${g.cantidad} 💎`;
                listaGanadoresEl.appendChild(li);
            });
        }
    </script>
</body>
</html>