<script>
        const socket = io(); 

        const listaParticipantesEl = document.getElementById('listaParticipantes');
        const listaGanadoresEl = document.getElementById('listaGanadores');
        const tiempoRestanteEl = document.getElementById('tiempoRestante');
        const logDonacionesEl = document.getElementById('logDonaciones');
        
        let tiempoActual = 0;
        let intervalo = null;
        let isPaused = false; // Nuevo estado para la pausa
        let participantes = [];
        let ganadoresHistorial = [];

        // --- FUNCIONES DE UTILIDAD ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function actualizarParticipantesUI() {
            participantes.sort((a, b) => b.cantidad - a.sort);
            
            const isWidgetMode = document.body.classList.contains('widget-mode');
            
            // 1. Apuntamos a las listas correctas
            const listaDashboardEl = document.getElementById('listaParticipantes');
            const listaWidgetEl = document.getElementById('listaParticipantes-widget'); 

            // 2. Limpiamos ambas listas
            if (listaDashboardEl) listaDashboardEl.innerHTML = "";
            if (listaWidgetEl) listaWidgetEl.innerHTML = "";
            
            let totalDiamantes = 0;
            const topN = participantes.slice(0, 5); // Tomamos el Top 5 para el widget

            participantes.forEach((p, index) => {
                const liDashboard = document.createElement("li");
                
                // Formato de Dashboard
                liDashboard.textContent = `${p.usuario} - ${p.cantidad} üíé`;
                if (listaDashboardEl) listaDashboardEl.appendChild(liDashboard);

                // Formato de Widget (Solo el Top 5)
                if (index < 5 && listaWidgetEl) {
                    const liWidget = document.createElement("li");
                    const rango = index + 1;
                    
                    const avatarUrl = p.avatar_url || 'https://via.placeholder.com/30/555/FFFFFF?text=A'; 

                    liWidget.innerHTML = `
                        <div class="rank-icon">${rango}</div>
                        <div class="user-info">
                            <div class="user-avatar"><img src="${avatarUrl}" alt="Avatar"></div>
                            <span class="username">${p.usuario}</span>
                        </div>
                        <span class="coins">${p.cantidad} ü™ô</span>
                    `;
                    listaWidgetEl.appendChild(liWidget);
                }
                
                totalDiamantes += p.cantidad;
            });
            
            if (!isWidgetMode) {
                 document.querySelector('#totalParticipantes').textContent = participantes.length;
                 document.querySelector('#totalDiamantes').textContent = totalDiamantes;
            }
        }

        function actualizarGanadoresUI() {
            const listaGanadoresEl = document.getElementById('listaGanadores');
            listaGanadoresEl.innerHTML = "";
            ganadoresHistorial.forEach(g => {
                const li = document.createElement('li');
                li.textContent = `üèÜ ${g.usuario} - ${g.cantidad} üíé`;
                listaGanadoresEl.appendChild(li);
            });
        }
        
        // --- L√ìGICA DEL TEMPORIZADOR ---
        function iniciarTimerLogic() {
            let tiempoInput = document.getElementById("tiempo");
            tiempoActual = parseInt(tiempoInput ? tiempoInput.value : 60);

            if (intervalo) clearInterval(intervalo);
            
            intervalo = setInterval(() => {
                if (!isPaused && tiempoActual > 0) { // Solo cuenta si NO est√° pausado
                    tiempoActual--;
                    const formattedTime = formatTime(tiempoActual);
                    
                    // Actualizamos ambos displays de tiempo
                    if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formattedTime;
                    if (document.getElementById('tiempoRestante-widget')) document.getElementById('tiempoRestante-widget').textContent = formattedTime;
                } else if (tiempoActual <= 0) {
                    terminarTiempo();
                }
            }, 1000);
        }

        function terminarTiempo() {
            if (intervalo) { clearInterval(intervalo); intervalo = null; }
            socket.emit('finalizar_subasta');
            
            // Ponemos ambos a 00:00 y detenemos la subasta
            if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formatTime(0);
            if (document.getElementById('tiempoRestante-widget')) document.getElementById('tiempoRestante-widget').textContent = formatTime(0);

            logDonacionesEl.innerHTML += `<p style="color: orange;">‚è±Ô∏è ¬°Tiempo terminado! Presiona 'Finalizar' para declarar al ganador.</p>`;
        }
        
        // --- FUNCIONES DE CONTROL ---
        function iniciar() {
            logDonacionesEl.innerHTML += `<p style="color: yellow;">‚ñ∂Ô∏è Solicitando conexi√≥n al live...</p>`;
            socket.emit("iniciar_subasta"); 
            isPaused = false; // Aseguramos que no est√© en pausa
            iniciarTimerLogic();
        }

        function finalizar() {
             terminarTiempo();
             tiempoActual = 0;
             logDonacionesEl.innerHTML += `<p style="color: red;">‚èπÔ∏è Ronda finalizada manualmente.</p>`;
             
             if (participantes.length > 0) {
                const ganador = participantes[0];
                ganadoresHistorial.unshift(ganador);
                logDonacionesEl.innerHTML += `<p style="color: gold;">üèÜ ¬°Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
                actualizarGanadoresUI();
             }
             participantes = [];
             actualizarParticipantesUI();
        }

        // FUNCI√ìN CLAVE PARA PAUSA
        function pausar() {
            isPaused = !isPaused; // Invierte el estado (true/false)
            if (isPaused) {
                logDonacionesEl.innerHTML += `<p style="color: orange;">‚è∏Ô∏è Temporizador en pausa.</p>`;
            } else {
                logDonacionesEl.innerHTML += `<p style="color: green;">‚ñ∂Ô∏è Temporizador reanudado.</p>`;
            }
        }
        
        function restart() {
            finalizar();
            participantes = [];
            ganadoresHistorial = [];
            actualizarParticipantesUI();
            actualizarGanadoresUI();
            logDonacionesEl.innerHTML = '<strong>üìù Historial de Eventos:</strong>';
            socket.emit("iniciar_subasta"); 
        }

        // --- EVENTOS DE COMUNICACI√ìN Y WIDGET ---
        socket.on('connect', () => logDonacionesEl.innerHTML += `<p style="color: lightgreen;">‚úîÔ∏è Conectado al servidor.</p>`);
        socket.on('conexion_exitosa', (mensaje) => {
            logDonacionesEl.innerHTML += `<p style="color: lightgreen;">‚úîÔ∏è ${mensaje}</p>`;
            participantes = [];
            actualizarParticipantesUI();
            // Si es widget, el temporizador ya se inici√≥
            if (!document.body.classList.contains('widget-mode')) {
                 iniciarTimerLogic();
            }
        });
        socket.on('error', (err) => alert(err));
        
        socket.on('actualizar_lista', (nuevaListaParticipantes) => {
            participantes = nuevaListaParticipantes;
            actualizarParticipantesUI();
        });


        // --- L√ìGICA DE DETECCI√ìN DE WIDGET ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'widget') {
            document.body.classList.add('widget-mode');
            document.getElementById('main-dashboard-content').style.display = 'none';
            document.getElementById('widget-container').style.display = 'flex';
            
            // En modo widget, el timer y la subasta se inician al cargar
            socket.emit("iniciar_subasta"); 
            iniciarTimerLogic();
        } else {
            document.getElementById('widget-container').style.display = 'none';
        }
    </script>