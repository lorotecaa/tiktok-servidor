<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subasta en Vivo</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="container">
    <!-- üü¢ Panel principal de Subasta -->
    <div class="panel-subasta">
      <h2>‚ö° Subasta en Vivo ‚ö°</h2>
      <table id="tablaParticipantes">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Monedas</th>
            <th>Regalo</th>
          </tr>
        </thead>
        <tbody id="participantesBody">
          <!-- Participantes activos se mostrar√°n aqu√≠ -->
        </tbody>
      </table>
    </div>

    <!-- üü£ Panel de Control -->
    <div class="panel-controles">
      <h3>üéÆ Controles</h3>
      <label for="usuarioTiktok">üë§ TikTok User:</label>
      <input type="text" id="usuarioTiktok" placeholder="@usuario" />

      <label for="tiempoInicial">‚è±Ô∏è Tiempo inicial (segundos):</label>
      <input type="number" id="tiempoInicial" value="200" />

      <div class="botones">
        <button id="btnIniciar">Iniciar</button>
        <button id="btnPausar">Pausar</button>
        <button id="btnFinalizar">Finalizar</button>
        <button id="btnReiniciar">Reiniciar</button>
      </div>
    </div>

    <!-- üü† Panel de Tiempo -->
    <div class="panel-tiempo">
      <h3>‚è≥ Tiempo Restante</h3>
      <div id="tiempoRestante">00:00</div>
    </div>
  </div>

  <script>
    const socket = io();

    let tiempoRestante = 0;
    let intervalo = null;
    let participantes = {};

    // üî• Iniciar subasta
    document.getElementById("btnIniciar").addEventListener("click", () => {
      const tiempo = parseInt(document.getElementById("tiempoInicial").value);
      const usuario = document.getElementById("usuarioTiktok").value.trim();

      if (!usuario) return alert("Ingresa un usuario de TikTok");

      participantes = {}; // Reiniciar lista local de participantes
      actualizarTabla();

      socket.emit("iniciar_subasta", { tiempo, usuario });
    });

    // ‚è∏Ô∏è Pausar
    document.getElementById("btnPausar").addEventListener("click", () => {
      clearInterval(intervalo);
    });

    // üõë Finalizar
    document.getElementById("btnFinalizar").addEventListener("click", () => {
      clearInterval(intervalo);
      socket.emit("finalizar_subasta");
    });

    // üîÑ Reiniciar manualmente
    document.getElementById("btnReiniciar").addEventListener("click", () => {
      participantes = {};
      actualizarTabla();
      document.getElementById("tiempoRestante").textContent = "00:00";
      clearInterval(intervalo);
    });

    // Evento desde el servidor ‚Üí iniciar subasta
    socket.on("subasta_iniciada", (data) => {
      tiempoRestante = data.tiempo;
      actualizarTiempo();

      clearInterval(intervalo);
      intervalo = setInterval(() => {
        tiempoRestante--;
        if (tiempoRestante <= 0) {
          clearInterval(intervalo);
          socket.emit("finalizar_subasta");
        }
        socket.emit("sync_time", tiempoRestante);
      }, 1000);
    });

    // Sincronizar tiempo entre widgets
    socket.on("update_time", (time) => {
      tiempoRestante = time;
      actualizarTiempo();
    });

    // Nueva donaci√≥n o regalo
    socket.on("new_gift", (giftData) => {
      const { username, giftName, repeatCount, coinCount } = giftData;

      // üîπ Corregido: contar monedas correctamente seg√∫n el valor real
      const totalMonedas = coinCount * (repeatCount || 1);

      if (!participantes[username]) {
        participantes[username] = { monedas: 0, regalo: giftName };
      }

      participantes[username].monedas += totalMonedas;
      participantes[username].regalo = giftName;

      actualizarTabla();
    });

    // Subasta finalizada
    socket.on("subasta_finalizada", () => {
      clearInterval(intervalo);
      alert("Subasta finalizada ‚úÖ");
    });

    // Funci√≥n para actualizar tabla de participantes
    function actualizarTabla() {
      const tbody = document.getElementById("participantesBody");
      tbody.innerHTML = "";

      const listaOrdenada = Object.entries(participantes).sort(
        (a, b) => b[1].monedas - a[1].monedas
      );

      listaOrdenada.forEach(([username, data]) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${username}</td>
          <td>${data.monedas}</td>
          <td>${data.regalo}</td>
        `;
        tbody.appendChild(fila);
      });
    }

    function actualizarTiempo() {
      const minutos = Math.floor(tiempoRestante / 60);
      const segundos = tiempoRestante % 60;
      document.getElementById("tiempoRestante").textContent = `${minutos
        .toString()
        .padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
    }
  </script>
</body>
</html>
