|<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âš¡ SUBSTINI âš¡</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-medium: #2c3e50;
            --bg-light: #3e5c76;
            --text-light: #e0e0e0;
            --text-dark: #ffffff;
            --accent-yellow: #FFD700;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-purple: #9b59b6;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            --border-radius: 12px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Contenedor principal del Dashboard */
        #main-dashboard-content {
            width: 100%;
            max-width: 1300px; /* Ajustado para un layout de 3 columnas */
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Encabezado */
        .header {
            background-color: var(--bg-medium);
            padding: 20px 30px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--box-shadow);
        }

        .header h1 {
            margin: 0;
            color: var(--accent-yellow);
            font-size: 3em;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header h1 span {
            font-size: 0.8em;
        }

        .header p {
            color: var(--text-light);
            font-size: 1.1em;
            margin-top: 5px;
        }

        /* Contenedores de las columnas */
        .dashboard-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr; /* Tres columnas */
            gap: 20px;
            align-items: start; /* Asegura que las columnas inicien al mismo nivel */
        }

        /* Estilo general para las cajas de informaciÃ³n/control */
        .box {
            background-color: var(--bg-medium);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            min-height: 200px; /* Altura mÃ­nima para que se vean bien */
            display: flex;
            flex-direction: column;
        }

        .box h2 {
            margin-top: 0;
            color: var(--text-dark);
            font-size: 1.6em;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .box h2 i {
            color: var(--accent-yellow); /* Iconos por defecto amarillos */
            font-size: 1.2em;
        }

        /* Colores especÃ­ficos para las cajas */
        #participantes-box h2 i { color: var(--accent-green); }
        #controles-config-box h2 i { color: var(--accent-purple); }
        #log-box h2 i { color: #808080; } /* Gris para el log */
        #ganadores-box h2 i { color: var(--accent-yellow); }
        #tiempo-restante-box {
            background-color: #34495e; /* Un color distinto para el tiempo */
            text-align: center;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        #tiempo-restante-box h2 {
             border-bottom: none;
             margin-bottom: 10px;
             color: var(--accent-yellow);
             font-size: 1.8em;
        }

        /* Estilos de inputs y labels */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-light);
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--bg-light);
            background-color: #34495e; /* MÃ¡s oscuro para inputs */
            color: var(--text-dark);
            font-size: 1em;
            box-sizing: border-box;
        }
        .form-group input[type="number"] {
            width: 80px; /* Ancho fijo para nÃºmeros */
        }

        /* Botones de control */
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Dos botones por fila */
            gap: 10px;
            margin-top: 20px;
        }

        .control-buttons button {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .control-buttons button:hover {
            transform: translateY(-2px);
        }

        .control-buttons .btn-start { background-color: var(--accent-green); color: var(--text-dark); }
        .control-buttons .btn-start:hover { background-color: #27ae60; }

        .control-buttons .btn-pause { background-color: #f39c12; color: var(--text-dark); }
        .control-buttons .btn-pause:hover { background-color: #e67e22; }

        .control-buttons .btn-stop { background-color: var(--accent-red); color: var(--text-dark); }
        .control-buttons .btn-stop:hover { background-color: #c0392b; }

        .control-buttons .btn-restart { background-color: #7f8c8d; color: var(--text-dark); }
        .control-buttons .btn-restart:hover { background-color: #95a5a6; }

        .control-buttons .btn-widget { background-color: #3498db; color: var(--text-dark); }
        .control-buttons .btn-widget:hover { background-color: #2980b9; }

        .control-buttons .btn-simulate { background-color: var(--accent-purple); color: var(--text-dark); }
        .control-buttons .btn-simulate:hover { background-color: #8e44ad; }
        
        .control-buttons .btn-generate-link { 
            grid-column: span 2; /* Ocupa ambas columnas */
            background-color: #34495e; 
            color: var(--text-light); 
            border: 1px dashed var(--accent-yellow);
        }
        .control-buttons .btn-generate-link:hover { background-color: #2c3e50; }

        /* Estilo para el tiempo restante grande */
        #tiempoRestante {
            font-size: 4em;
            font-weight: 700;
            color: var(--accent-yellow);
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin-top: 15px;
            display: block;
        }

        /* Listas de participantes y ganadores */
        .list-container {
            flex-grow: 1; /* Para que la lista ocupe el espacio restante */
            overflow-y: auto; /* Scroll si hay muchos elementos */
        }
        .list-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .list-container li {
            background-color: #34495e; /* Fondo para cada item de la lista */
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .list-container li:first-child { /* Estilo para el primer participante/ganador */
            background-color: var(--accent-yellow);
            color: var(--bg-dark);
            font-weight: 700;
        }
        .list-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .list-item-info img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .list-item-coins {
            font-weight: 700;
            color: var(--accent-green); /* Color para las monedas */
            font-size: 1.1em;
        }
        .list-container li:first-child .list-item-coins {
            color: var(--bg-dark); /* Color oscuro para monedas del top1 */
        }

        /* Totales en Participantes */
        .participantes-totales {
            margin-top: auto; /* Empuja los totales al final de la caja */
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* Log de Donaciones */
        #logDonaciones {
            background-color: #1c2833; /* Fondo mÃ¡s oscuro para el log */
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border-radius: var(--border-radius);
            font-size: 0.9em;
            line-height: 1.5;
            color: #b0c4de; /* Color de texto mÃ¡s claro */
        }
        #logDonaciones p {
            margin: 5px 0;
            padding-left: 10px;
            border-left: 3px solid rgba(255, 255, 255, 0.1);
        }
        #logDonaciones strong {
            color: var(--accent-yellow);
            display: block;
            margin-bottom: 10px;
        }

        /* Estilos del Widget (mantienen la funcionalidad original, solo adaptados visualmente si es necesario) */
        .widget-mode body {
            background-color: transparent;
            padding: 0;
            min-height: 0;
        }
        .widget-mode #main-dashboard-content { display: none !important; }
        #widget-container {
            display: none; /* Inicia oculto, JS lo activa en modo widget */
            flex-direction: column;
            width: 360px; /* Ancho fijo para el widget */
            background: linear-gradient(180deg, #0a0a0a 0%, #0f1626 100%);
            border-radius: 10px;
            overflow: hidden;
            border: 4px solid var(--accent-yellow);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
            color: var(--text-light);
            font-family: 'Poppins', sans-serif;
        }
        #tiempoBox-widget {
            background: #1a1a1a;
            width: 100%;
            padding: 10px 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid var(--accent-yellow);
        }
        #tiempoRestante-widget {
            font-size: 2.5em;
            color: var(--accent-yellow);
            font-weight: bold;
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.7);
        }
        #subtext-widget {
            font-size: 14px;
            color: #ccc;
            margin-top: 5px;
        }
        .snipe-alert #tiempoRestante-widget {
            color: var(--accent-red) !important;
            text-shadow: 0 0 15px rgba(255, 77, 77, 1) !important;
        }
        .snipe-alert #subtext-widget {
            color: var(--accent-red) !important;
        }
        #listaParticipantes-widget {
            min-width: unset; /* Reiniciar el min-width del dashboard */
            padding: 15px;
            background-color: #1a1a2e; /* Fondo de la lista del widget */
            flex-grow: 1;
            overflow-y: auto;
        }
        #listaParticipantes-widget li {
            background-color: #2c3e50;
            border-bottom: none;
            margin-bottom: 5px;
            color: var(--text-light);
        }
        #listaParticipantes-widget li:first-child {
            background-color: var(--accent-yellow);
            color: var(--bg-dark);
        }
        #listaParticipantes-widget .list-item-coins {
            color: var(--accent-green);
        }
        #listaParticipantes-widget li:first-child .list-item-coins {
            color: var(--bg-dark);
        }

        /* Popup de Ganador en Widget */
        #widget-winner-popup {
            position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
            z-index: 9999;
            background: rgba(0,0,0,0.85); color: #fff;
            padding: 25px 50px; border-radius: 20px;
            text-align: center; font-size: 1.6em;
            backdrop-filter: blur(6px); box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            animation: popIn 0.4s ease;
        }
        #widget-winner-popup img {
            width:60px; height:60px; border-radius:50%; border:3px solid gold;
        }
        #widget-winner-popup > div {
            display:flex; align-items:center; justify-content:center; gap:15px;
        }
        #widget-winner-popup .winner-title {
            font-weight:bold; color:#FFD700;
        }
        #widget-winner-popup .winner-amount {
            font-size:1.2em;
        }
        @keyframes popIn {
            0% { transform: translate(-50%, -20px) scale(0.8); opacity: 0; }
            100% { transform: translate(-50%, 0) scale(1); opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="main-dashboard-content">
        <div class="header">
            <h1>âš¡ SUBSTINI âš¡</h1>
            <p>interactive game tiktok by lorotecay!</p>
        </div>

        <div class="dashboard-columns">
            <div id="participantes-box" class="box">
                <h2><i class="fas fa-users"></i> Participantes (Ronda Actual)</h2>
                <div class="list-container">
                    <ul id="listaParticipantes">
                        </ul>
                </div>
                <div class="participantes-totales">
                    <p>Total participantes: <span id="totalParticipantes">0</span></p>
                    <p>Diamantes donados: <span id="totalDiamantes">0</span></p>
                </div>
            </div>

            <div>
                <div id="controles-config-box" class="box" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-cogs"></i> Controles</h2>
                    <div class="form-group">
                        <label for="idUnico">ID Ãšnico (para Widget):</label>
                        <input type="text" id="idUnico" value="MI_STREAM_ID" placeholder="ID Ãšnico para la sala">
                    </div>
                    <div class="form-group">
                        <label for="tiktokUser">Usuario TikTok:</label>
                        <input type="text" id="tiktokUser" value="mi_usuario_tiktok" placeholder="Tu usuario TikTok">
                    </div>
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px;">
                        <div class="form-group" style="flex: 1;">
                            <label for="tiempoInicial">Tiempo inicial (segundos):</label>
                            <input type="number" id="tiempoInicial" value="60">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label for="tiempoSnipe">Tiempo de snipe (segundos):</label>
                            <input type="number" id="tiempoSnipe" value="15">
                        </div>
                    </div>

                    <div class="control-buttons">
                        <button class="btn-start" onclick="iniciarSubasta()"><i class="fas fa-play"></i> Iniciar</button>
                        <button class="btn-pause" onclick="pausar()"><i class="fas fa-pause"></i> Pausar</button>
                        <button class="btn-stop" onclick="finalizar()"><i class="fas fa-stop"></i> Finalizar</button>
                        <button class="btn-restart" onclick="restart()"><i class="fas fa-redo"></i> Restart</button>
                        <button class="btn-widget" onclick="abrirWidget()"><i class="fas fa-tv"></i> Ver Widget</button>
                        <button class="btn-simulate" onclick="simularRegalo()"><i class="fas fa-gifts"></i> Simular Regalo</button>
                        <button class="btn-generate-link" onclick="generarLinkWidget()"><i class="fas fa-link"></i> Generar Link Widget</button>
                    </div>
                </div>

                <div id="tiempo-restante-box" class="box">
                    <h2>Tiempo Restante</h2>
                    <span id="tiempoRestante">00:00</span>
                </div>
            </div>

            <div>
                <div id="log-box" class="box" style="margin-bottom: 20px;">
                    <h2><i class="fas fa-clipboard-list"></i> Historial de Eventos:</h2>
                    <div id="logDonaciones" class="list-container">
                        <strong>ğŸ“ Historial de Eventos:</strong><p style="color: cyan;">Esperando conexiÃ³n...</p>
                    </div>
                </div>

                <div id="ganadores-box" class="box">
                    <h2><i class="fas fa-trophy"></i> Ganadores de Rondas</h2>
                    <div class="list-container">
                        <ul id="historialGanadores">
                            </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="winner-popup">
        <div id="winner-content">
            <div id="winner-avatar"><img src="https://via.placeholder.com/150/555/FFFFFF?text=A" alt="Avatar Ganador"></div>
            <div style="font-size: 1.5em; color: #ccc;">Â¡El ganador es!</div>
            <div id="winner-name"></div>
            <div id="winner-amount"></div>
        </div>
    </div>

    <div id="widget-container">
        <div id="tiempoBox-widget">
            <div id="subtext-widget">El sorteo/subasta termina en</div>
            <div id="tiempoRestante-widget">00:00</div>
        </div>
        <hr style="width: 80%; border-color: var(--accent-yellow); margin: 15px auto;">
        <ul id="listaParticipantes-widget">
            </ul>
    </div>

    
    
    <script> const socket = io("https://tiktok-servidor.onrender.com"); // tu URL real de Render

        const listaParticipantesEl = document.getElementById('listaParticipantes');
        const listaGanadoresEl = document.getElementById('listaGanadores');
        const tiempoRestanteEl = document.getElementById('tiempoRestante');
        const logDonacionesEl = document.getElementById('logDonaciones');
        
        let tiempoActual = 0;
        let intervalo = null;
        let participantes = [];
        let ganadoresHistorial = [];
        let isPaused = false; // Estado para la funciÃ³n pausar
        let snipeActivado = false; // <-- AÃ‘ADE ESTA LÃNEA
        let subastaActiva = false;
        let isSnipeModeVisual = false;
        let isConnectedValid = false;

        // ğŸ‘‡ INICIO: AÃ‘ADIDO BLOQUE (PROTECCIÃ“N ANTI-DUPLICADOS) ğŸ‘‡
        const processedGiftIds = new Set();
        setInterval(() => {
          processedGiftIds.clear();
          console.log("Limpiando cachÃ© de IDs de regalos procesados.");
        }, 60000); // Limpia los IDs cada 60 segundos
        // ğŸ‘† FIN: AÃ‘ADIDO BLOQUE ğŸ‘†

        // --- FUNCIONES DE UTILIDAD ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function actualizarParticipantesUI() {
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));
            
            const isWidgetMode = document.body.classList.contains('widget-mode');
            
            // 1. Apuntamos a las listas correctas
            const listaDashboardEl = document.getElementById('listaParticipantes');
            const listaWidgetEl = document.getElementById('listaParticipantes-widget'); 

            // 2. Limpiamos ambas listas
            if (listaDashboardEl) listaDashboardEl.innerHTML = "";
            if (listaWidgetEl) listaWidgetEl.innerHTML = "";
            
            let totalDiamantes = 0;
            const topN = participantes.slice(0, 5); // Tomamos el Top 5 para el widget

            participantes.forEach((p, index) => {
                const liDashboard = document.createElement("li");
                
                // Formato de Dashboard
                liDashboard.textContent = `${p.usuario} - ${p.cantidad} ğŸ’`;
                if (listaDashboardEl) listaDashboardEl.appendChild(liDashboard);

                // Formato de Widget (Solo el Top 5)
                if (index < 5 && listaWidgetEl) {
                    const liWidget = document.createElement("li");
                    const rango = index + 1;
                    
                    const avatarUrl = p.avatar_url || 'https://via.placeholder.com/30/555/FFFFFF?text=A'; 

                    liWidget.innerHTML = `
                        <div class="rank-icon">${rango}</div>
                        <div class="user-info">
                            <div class="user-avatar"><img src="${avatarUrl}" alt="Avatar"></div>
                            <span class="username">${p.usuario}</span>
                        </div>
                        <span class="coins">${p.cantidad} ğŸª™</span>
                    `;
                    listaWidgetEl.appendChild(liWidget);
                }
                
                totalDiamantes += p.cantidad;
            });
            
            if (!isWidgetMode) {
                 document.querySelector('#totalParticipantes').textContent = participantes.length;
                 document.querySelector('#totalDiamantes').textContent = totalDiamantes;
            }
        }
        function obtenerGanador() {
    if (participantes.length === 0) return null;
    return participantes.reduce((max, p) => (p.coins > max.coins ? p : max));
}


        function actualizarGanadoresUI() {
            const listaGanadoresEl = document.getElementById('listaGanadores');
            listaGanadoresEl.innerHTML = "";
            ganadoresHistorial.forEach(g => {
                const li = document.createElement('li');
                li.textContent = `ğŸ† ${g.usuario} - ${g.cantidad} ğŸ’`;
                listaGanadoresEl.appendChild(li);
            });
        }
        
        // --- LÃ“GICA DEL TEMPORIZADOR ---
        function iniciarTimerLogic() {
            let tiempoInput = document.getElementById("tiempo");
            // Solo resetea si el tiempo es 0 o indefinido (inicio)
            if (tiempoActual <= 0) {
                 tiempoActual = parseInt(tiempoInput ? tiempoInput.value : 200); // Usar 200 como default si no hay input
            }


            if (intervalo) clearInterval(intervalo);
            
            intervalo = setInterval(() => {
                if (!isPaused && tiempoActual > 0) {
                    tiempoActual--;
                    const formattedTime = formatTime(tiempoActual);
                    
                    // 1. DASHBOARD EMITE LA HORA AL SERVIDOR (MAESTRO)
                    if (!document.body.classList.contains('widget-mode')) {
                        socket.emit('sync_time', tiempoActual); 
                    }
                    
                    // 2. Actualizamos el display LOCAL del dashboard
                    if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formattedTime;

                } else if (tiempoActual <= 0) {
                     // Solo el dashboard detiene el tiempo
                    if (!document.body.classList.contains('widget-mode')) {
                        terminarTiempo();
                    }
                }
            }, 1000);
        }

        // --- FUNCIONES DE CONTROL ---
        function iniciar() {
    if (!document.body.classList.contains('widget-mode')) { 
        
        // ğŸ›‘ VALIDACIÃ“N 1: Verificar si el ID estÃ¡ en el input
        const idUnicoEl = document.getElementById('idUnico');
        const streamerIdActual = idUnicoEl ? idUnicoEl.value.trim() : "";
        
        if (!streamerIdActual) {
            alert("âš ï¸ ERROR: Debes escribir el ID Ãšnico (para Widget) antes de iniciar la subasta.");
            logDonacionesEl.innerHTML += `<p style="color: red;">ğŸ›‘ ERROR: ID Ãšnico no especificado. No se puede iniciar la subasta.</p>`;
            return; // Detiene la funciÃ³n aquÃ­
        }
        
        // Llama a la conexiÃ³n. La lÃ³gica de inicio debe ir DESPUÃ‰S de la conexiÃ³n.
        conectarDashboard(); 

        // ğŸ›‘ VALIDACIÃ“N 2: CRÃTICA. SOLO INICIAR SI EL ID ES VÃLIDO EN EL SERVIDOR
        if (!isConnectedValid) {
            alert("âš ï¸ ERROR: El ID no ha sido validado por el servidor. Revisa si hay un mensaje de error.");
            return; // Detiene la funciÃ³n si el servidor ya marcÃ³ el ID como invÃ¡lido
        }
        
        // --- LÃ³gica de inicio (SOLO se ejecuta si isConnectedValid es true) ---
        snipeActivado = false; 
        subastaActiva = true; 
        logDonacionesEl.innerHTML += `<p style="color: yellow;">â–¶ï¸ Iniciando ronda...</p>`;
        
        // Si el servidor valida el ID y llegamos aquÃ­, entonces enviamos el evento
        socket.emit("iniciar_subasta"); 
        
        isPaused = false; 
        tiempoActual = 0; 
        iniciarTimerLogic(); // Inicia el reloj maestro en el dashboard
    }
}
function conectarDashboard() {
    // 1. Lee ÃšNICAMENTE el input ID Ãšnico
    const idUnicoEl = document.getElementById('idUnico');
    let streamerIdActual = idUnicoEl ? idUnicoEl.value : "";

    if (!streamerIdActual) {
        alert("ERROR: Debes escribir el ID Ãšnico (para Widget) antes de iniciar la subasta.");
        isConnectedValid = false; // âŒ Asegura que sea falso si falta el ID
        return; 
    }
    
    // ğŸ†• AÃ‘ADE ESTA LÃNEA CLAVE ğŸ†•
    // ASUMIMOS que el ID serÃ¡ vÃ¡lido. SOLO el evento 'id_invalido' la pondrÃ¡ en 'false'.
    isConnectedValid = true; 

    // 2. Establecer el TikTok User
    let tiktokUserActual = "No Requerido";
    
    // 3. Emitir el evento de conexiÃ³n
    socket.emit("join_room", { 
        streamerId: streamerIdActual, 
        tiktokUser: tiktokUserActual 
    }); 
    
    // 4. Actualizar las variables globales
    streamerId = streamerIdActual; 
    tiktokUser = tiktokUserActual; 

    console.log(`DASHBOARD intentando unirse a sala: ${streamerIdActual}`);
}
        function terminarTiempo() {
    // 1. Esta funciÃ³n solo debe correr en el Dashboard (el "Maestro")
    if (!document.body.classList.contains('widget-mode')) { 
        socket.emit("restaurar_widget");

        // 2. Detiene el reloj
        if (intervalo) { 
            clearInterval(intervalo); 
            intervalo = null; 
        }

        // 3. Avisa a todos que el tiempo (y la subasta) se acabÃ³
        socket.emit('finalizar_subasta'); // Avisa al servidor que no acepte mÃ¡s regalos
        socket.emit('sync_time', 0); // EnvÃ­a '0' a los widgets
        tiempoActual = 0; 
        if (document.getElementById('tiempoRestante')) {
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        }

        // 4. Revisa si hay que activar el SNIPE
        // (Nota: cambiÃ© el default de 15 a 0 para mÃ¡s seguridad)
        const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;

        if (!snipeActivado && tiempoSnipe > 0) {
            // A) AÃšN QUEDA EL SNIPE
            snipeActivado = true; // Marcamos que el snipe ya se usÃ³
            logDonacionesEl.innerHTML += `<p style="color: yellow;">âš¡ Modo SNIPE activado (${tiempoSnipe}s extra)</p>`;

            // Avisamos a los widgets del nuevo tiempo
            socket.emit("iniciar_snipe_cliente", tiempoSnipe);

            // ğŸ›‘ NUEVA EMISIÃ“N: Avisamos a los Widgets que inicien la ALERTA ROJA ğŸ›‘
            socket.emit("activar_alerta_snipe_visual"); // <--- AÃ‘ADE ESTA LÃNEA

            // Reiniciamos el temporizador local solo con el tiempo de snipe
            tiempoActual = tiempoSnipe;
            iniciarTimerLogic();

        } 
        else {
            // B) NO HAY SNIPE (o el snipe ya terminÃ³)
            // Â¡AquÃ­ es donde ocurre la finalizaciÃ³n automÃ¡tica!

            if (snipeActivado) {
                logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada automÃ¡ticamente (post-snipe).</p>`;
            } else {
                logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada automÃ¡ticamente (sin snipe).</p>`;
            }

            // --- INICIO DE LA LÃ“GICA MOVIDA DESDE 'FINALIZAR' ---
            if (participantes.length > 0) {
                const ganador = participantes[0]; // El primer elemento ya estÃ¡ ordenado
                ganadoresHistorial.unshift(ganador); // AÃ±adir al principio del historial
                logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ† Â¡Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
                actualizarGanadoresUI();
                socket.emit("anunciar_ganador", ganador);
            } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â logDonacionesEl.innerHTML += `<p style="color: gray;">â„¹ï¸ No hubo participantes en esta ronda.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  }
}
} 
        function finalizar() {
    // 1. Esta funciÃ³n solo debe correr en el Dashboard (el "Maestro")
    if (!document.body.classList.contains('widget-mode')) {

        // 2. Detener CUALQUIER temporizador que estÃ© activo
        if (intervalo) { 
            clearInterval(intervalo); 
            intervalo = null; 
        }
        
        // 3. Sincronizar el tiempo a 0 en todos lados
        tiempoActual = 0;
        socket.emit('sync_time', 0); // EnvÃ­a '0' a los widgets
        if (document.getElementById('tiempoRestante')) {
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        }
        
        // 4. Avisar al servidor que la subasta se detenga INMEDIATAMENTE
        socket.emit('finalizar_subasta'); 

        // 5. Loggear que fue manual
        logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada manualmente.</p>`;

        // 6. Procesar al ganador (si existe)
        if (participantes.length > 0) {
                        
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad)); // Ordena de mayor a menor (con parseInt)

            const ganador = participantes[0]; // Ahora sÃ­, el [0] es el que mÃ¡s donÃ³
            ganadoresHistorial.unshift(ganador); 
            logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ† Â¡Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
            actualizarGanadoresUI();
            socket.emit("anunciar_ganador", ganador); // EnvÃ­a al ganador correcto
        
        } else {
             logDonacionesEl.innerHTML += `<p style="color: gray;">â„¹ï¸ No hubo participantes en esta ronda.</p>`;
        }

        // 7. APAGAR EL INTERRUPTOR Y LIMPIAR (SIEMPRE)
        subastaActiva = false; // <--- LUGAR CORRECTO (Fuera del if/else del ganador)
        participantes = []; 
        actualizarParticipantesUI(); 
        socket.emit("limpiar_listas"); // (Esta es la Ãºnica llamada que debe estar)
    }
}
        // --- ğŸ‘‡ Â¡AQUÃ ESTÃ EL ARREGLO! ğŸ‘‡ ---
        // Manda la orden de limpiar SIEMPRE, 
        // sin importar si hubo ganador o no.
        socket.emit("limpiar_listas");
        // --- ğŸ‘† FIN DEL ARREGLO ğŸ‘† ---
          
        function restart() {
    if (!document.body.classList.contains('widget-mode')) { // Solo el dashboard puede reiniciar
        finalizar(); // Finaliza la ronda actual (guarda ganador si hay, limpia lista)
        // Limpia el historial de ganadores tambiÃ©n
        ganadoresHistorial = [];
        actualizarGanadoresUI();
        
        // ğŸ” Resetea variables globales
        snipeActivado = false; // <-- Muy importante para permitir un nuevo snipe en la siguiente subasta
        
        logDonacionesEl.innerHTML = '<strong>ğŸ“ Historial de Eventos:</strong><p style="color: cyan;">ğŸ”„ Sistema reiniciado. Listo para una nueva subasta.</p>';
        
        // No emitimos iniciar_subasta aquÃ­, esperamos que el usuario presione Iniciar
        // Pero sÃ­ reseteamos el tiempo visual a 0
        if (document.getElementById('tiempoRestante')) 
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        
        socket.emit('sync_time', 0); // Asegurar que widgets muestren 0
    }
}


        function pausar() {
            if (!document.body.classList.contains('widget-mode')) { // Solo el dashboard puede pausar
                isPaused = !isPaused; // Invierte el estado (true/false)
                if (isPaused) {
                    if (intervalo) clearInterval(intervalo); // Detenemos el intervalo local
                    intervalo = null; // Marcar como detenido
                    logDonacionesEl.innerHTML += `<p style="color: orange;">â¸ï¸ Temporizador en pausa.</p>`;
                    // No enviamos nada al servidor, el widget se queda con la Ãºltima hora recibida
                } else {
                    iniciarTimerLogic(); // Reanudamos la lÃ³gica (continÃºa desde tiempoActual)
                    logDonacionesEl.innerHTML += `<p style="color: green;">â–¶ï¸ Temporizador reanudado.</p>`;
                }
            }
        }
        // ğŸ‘‡ AÃ‘ADE ESTA FUNCIÃ“N COMPLETA ğŸ‘‡
        function simularRegalo() {
            // Solo el dashboard (maestro) puede simular
            if (document.body.classList.contains('widget-mode')) return;

            // 1. Nombres y montos aleatorios
            const nombres = ["GatitoVeloz", "LoboEstelar", "ZorroGamer", "PandaNinja", "DragonRojo"];
            const randomUser = nombres[Math.floor(Math.random() * nombres.length)] + Math.floor(Math.random() * 500);
            const randomAmount = Math.floor(Math.random() * 100) + 1; // Simular donaciÃ³n de 1 a 100
            const giftName = "SimulaciÃ³n";

            // 2. Obtener el total anterior (si el usuario ya existe)
            const existente = participantes.find(p => p.usuario === randomUser);
            let nuevoTotal;

            if (existente) {
                nuevoTotal = existente.cantidad + randomAmount; // Sumamos la nueva donaciÃ³n al total
            } else {
                nuevoTotal = randomAmount; // Es un usuario nuevo
            }
            
            // 3. Mostrar en el log del dashboard
            logDonacionesEl.innerHTML += `<p style="color: gray;">[SIM] ${randomUser} enviÃ³ +${randomAmount}ğŸª™ (Nuevo Total: ${nuevoTotal})</p>`;
            logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

            // 4. Emitir al servidor el *NUEVO TOTAL*
            // (El servidor lo retransmitirÃ¡, y socket.on("new_gift") lo reemplazarÃ¡)
            socket.emit("nuevo_regalo", {
                usuario: randomUser,
                cantidad: nuevoTotal,
                regalo: giftName,
                // ğŸ‘‡ AÃ‘ADE ESTA LÃNEA ğŸ‘‡
                avatar_url: `https://via.placeholder.com/30/555/FFFFFF?text=${randomUser.charAt(0)}`
            });
        }
        // ğŸ‘† FIN DE LA FUNCIÃ“N NUEVA ğŸ‘†

        // --- EVENTOS DE SINCRONIZACIÃ“N (El Widget recibe la hora) ---
        socket.on('update_time', (time) => {
    
    if (document.body.classList.contains('widget-mode')) {
        
        // ... (Tu lÃ³gica existente para subastaActiva) ...

        tiempoActual = time;
        const formattedTime = formatTime(time);
        
        const tiempoElWidget = document.getElementById('tiempoRestante-widget'); 
        const subtextElWidget = document.getElementById('subtext-widget');
        
        if (tiempoElWidget) tiempoElWidget.textContent = formattedTime;
        
        // ğŸ›‘ LÃ“GICA DE CAMBIO DE CLASE AHORA USA LA BANDERA ğŸ›‘
        
        // Si la bandera estÃ¡ ACTIVA (solo se activa cuando el tiempo llega a cero por primera vez)
        if (isSnipeModeVisual && time > 0) {
            
            // 1. Activa la clase 'snipe-alert'. Â¡El contador se pone ROJO!
            document.body.classList.add('snipe-alert');
            
            // 2. Cambia el texto del subtÃ­tulo a la alerta
            if (subtextElWidget) {
                subtextElWidget.textContent = "Tiempo por delay de live"; 
            }
        
        } else {
            
            // 1. Desactiva la clase (vuelve al AMARILLO original si no estÃ¡ en Snipe)
            document.body.classList.remove('snipe-alert');
            
            // 2. Restaura el texto original del subtÃ­tulo (si la subasta aÃºn no ha terminado, es el texto por defecto)
            if (subtextElWidget) {
                subtextElWidget.textContent = "El sorteo/subasta termina en"; 
            }
        }
    }
});

        // --- LÃ“GICA DE DETECCIÃ“N DE WIDGET Y CONEXIÃ“N TIKFINITY ---
// ...
const urlParams = new URLSearchParams(window.location.search);
const isWidgetMode = urlParams.get('mode') === 'widget'; // Variable global (ya existe)


// 1. Obtener los valores de los inputs
let streamerId = "ID_POR_DEFECTO"; // â¬…ï¸ IMPORTANTE: ESTO DEBE CAMBIAR
let tiktokUser = "USUARIO_POR_DEFECTO"; // â¬…ï¸ ESTO DEBE CAMBIAR
const idUnicoEl = document.getElementById('idUnico');
const tiktokUserEl = document.getElementById('tiktokUser');

if (idUnicoEl) {
    streamerId = idUnicoEl.value; // Lee el valor
}
if (tiktokUserEl) {
    tiktokUser = tiktokUserEl.value; // Lee el valor
}
// ...

if (isWidgetMode) {
    // ===============================
    // ğŸƒ MODO WIDGET (ESCLAVO)
    // ===============================
    document.body.classList.add('widget-mode');
    
    // Si estamos en widget, el streamerId debe venir de la URL
    streamerId = urlParams.get('id'); 
    
    // Ocultamos el dashboard principal y mostramos el contenedor del widget
    document.getElementById('main-dashboard-content').style.display = 'none';
    document.getElementById('widget-container').style.display = 'flex';
    
    if (streamerId) {
        // El Widget se une a la sala
        socket.emit("join_room", { streamerId: streamerId, tiktokUser: "WidgetCliente" }); // El Widget se identifica como tal
        console.log(`WIDGET unido a la sala: ${streamerId} (WidgetCliente)`);
    }

} else {
    // ===============================
    // ğŸ–¥ï¸ MODO DASHBOARD (MAESTRO)
    // ===============================
    document.getElementById('widget-container').style.display = 'none';
    
    if (streamerId) { // Si hay ID Ãšnico ingresado
        // El Dashboard se une a la sala
        console.log(`DASHBOARD unido a la sala: ${streamerId} (${tiktokUser})`);

        // ğŸ CONEXIÃ“N CON TIKFINITY EVENT API (SOLO DASHBOARD) <--- TU CÃ“DIGO COMIENZA AQUÃ
        // ... (El resto de tu lÃ³gica de conexiÃ³n a TikFinity) ...
    } else {
        console.error("ID Ãšnico no ingresado. Por favor, complete el campo 'ID Ãšnico (para Widget)'.");
    }
}

             // ===============================
             // ğŸ CONEXIÃ“N CON TIKFINITY EVENT API (SOLO DASHBOARD) <--- MOVIDO AQUÃ
             // ===============================
             try {
                 const tiktokWS = new WebSocket("ws://localhost:21213/");

                 tiktokWS.onopen = () => {
                     console.log("âœ… Conectado a TikFinity Event API");
                     // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (logDonacionesEl) {
                         logDonacionesEl.innerHTML += `<p style="color: cyan;">âœ… Conectado a TikFinity Event API</p>`;
                     }
                 };

                 tiktokWS.onmessage = (event) => {
                     // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (!logDonacionesEl) return; 
                     if (!subastaActiva) {
                        return; // Ignora todo si la subasta no estÃ¡ activa
         }

                     try {
                         const msg = JSON.parse(event.data);
                         if (!msg.event) return;

                         switch (msg.event) {
                             case "gift": { // ğŸŒŸ INICIO DE LA CORRECCIÃ“N FINAL ğŸŒŸ
                                 const gift = msg.data;
                                 console.log("DATOS COMPLETOS REGALO:", JSON.stringify(gift, null, 2));  

                                 // 1ï¸âƒ£ ID ÃšNICO del evento
                                 const giftEventId = gift.msgId;   
                                 if (!giftEventId) {
                                     console.log("Ignorando evento gift sin msgId");
                                     break; // No podemos procesar sin ID de evento
                                 }

                                 // 2ï¸âƒ£ Ignorar duplicados (por seguridad)
                                 if (processedGiftIds.has(giftEventId)) {
                                     console.log(`Regalo ya procesado: ${giftEventId}`);
                                     break;
                                 }

                                 // 3ï¸âƒ£ Filtro inteligente:
                                 // - Si tiene repeatEnd: procesamos solo el final
                                 // - Si NO tiene repeatEnd: lo procesamos igual (regalos grandes o Ãºnicos)
                                 if (gift.repeatEnd === false) { 
                                 
                                 // ğŸ›‘ ExcepciÃ³n clave: Si el regalo vale 100 o mÃ¡s, lo procesamos.
                                 if (gift.diamondCount >= 100) {
                                     console.log(`ğŸ’ Regalo grande (>=100) detectado: Procesando a pesar de repeatEnd: false.`);
                                 } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â     console.log(`Ignorando evento intermedio (repeatEnd: false). Esperando el final del combo.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â     break;
                                 }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
                                 
                                 // (Si repeatEnd es 'true' o 'undefined', el cÃ³digo continÃºa)

                                 // 4ï¸âƒ£ Marcamos el ID como procesado
                                 processedGiftIds.add(giftEventId);

                                 // 5ï¸âƒ£ Calculamos el total de diamantes correctamente
                                 const totalDiamonds = (gift.diamondCount || 0) * (gift.repeatCount || 1);
                                 
                                 // 5.1 No procesar regalos sin valor (por si acaso)
                                 if (totalDiamonds === 0) {
                                     console.log("Ignorando regalo con 0 diamantes.");
                                     break;
                                 }

                                 // 6ï¸âƒ£ Mostramos en pantalla y enviamos al servidor
                                 logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ ${gift.uniqueId} enviÃ³ ${gift.giftName} (${totalDiamonds}ğŸ’)</p>`;
                                 
                                 socket.emit("nuevo_regalo", {
    usuario: gift.uniqueId,
    cantidad: totalDiamonds,
    regalo: gift.giftName,
    avatar_url: gift.profilePictureUrl, // â¬…ï¸ Â¡AGREGA ESTA COMA!
    streamerId: streamerId // CRÃTICO: ANADE ESTA LINEA
});

                                 break; // âœ… Fin del case
                             }

                             case "chat":
                                 const chat = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: lightgreen;">ğŸ’¬ ${chat.uniqueId}: ${chat.comment}</p>`;
                                 break;

                             case "like":
                                 const like = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: pink;">â¤ï¸ ${like.uniqueId} dio like</p>`;
                                 break;

                             case "follow":
                                 const follow = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: orange;">â­ ${follow.uniqueId} empezÃ³ a seguirte</p>`;
                                 break;
                         }

                         // Mantenemos el log visible siempre abajo
                         logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

                     } catch (e) {
                         console.error("Error al procesar mensaje TikFinity:", e);
                         logDonacionesEl.innerHTML += `<p style="color: red;">âš ï¸ Error procesando evento TikFinity.</p>`;
                     }
                 };

                 tiktokWS.onclose = () => {
                      // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (logDonacionesEl) {
                         logDonacionesEl.innerHTML += `<p style="color: red;">âŒ Desconectado de TikFinity Event API</p>`;
                     }
                 };

             } catch (err) {
                 console.error("Error al conectar con TikFinity:", err);
                  // Asegurarse de que logDonacionesEl exista antes de usarlo
                 if (logDonacionesEl) {
                     logDonacionesEl.innerHTML += `<p style="color: red;">âŒ Error al conectar con TikFinity.</p>`;
                 }
             }

        // ===============================
// ğŸ ESCUCHAR REGALOS EN TIEMPO REAL DESDE EL SERVIDOR
// (Esto corre en AMBOS: Dashboard y Widget)
// ===============================
socket.on("new_gift", (gift) => {
            console.log("ğŸ’ Nuevo regalo recibido del servidor:", gift);

            const existente = participantes.find(p => p.usuario === gift.usuario);
            // Tomamos la cantidad del regalo que nos envÃ­an (ej: 1 rosa, 100 leones)
            const cantidadDelRegalo = parseInt(gift.cantidad) || 0; 

            if (existente) {
                // ğŸ›‘ CORRECCIÃ“N CRÃTICA: Sumamos la cantidad nueva a la cantidad existente
                existente.cantidad = parseInt(existente.cantidad) + cantidadDelRegalo; 
                existente.avatar_url = gift.avatar_url;
            } else {
                // ğŸ’¡ Es un usuario nuevo
                participantes.push({
                    usuario: gift.usuario,
                    cantidad: cantidadDelRegalo, 
                    regalo: gift.regalo,
                    avatar_url: gift.avatar_url
                });
            }

            // ğŸ’¡ Ordena la lista CADA VEZ que llegue un regalo.
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));

            // ğŸ›‘ LÃ“GICA DE SNIPE: Reiniciar el contador si la subasta estÃ¡ en modo snipe
            if (!document.body.classList.contains('widget-mode') && snipeActivado && cantidadDelRegalo > 0) {
                const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;
                
                // Si el tiempo estÃ¡ bajo o en 0 (esperando el final)
                if (tiempoActual <= tiempoSnipe) {
                    tiempoActual = tiempoSnipe;
                    socket.emit('sync_time', tiempoActual); 
                    logDonacionesEl.innerHTML += `<p style="color: red;">â° SNIPE: Tiempo restablecido a ${tiempoSnipe}s!</p>`;
                }
            }
// ğŸ“¢ Â¡AQUÃ VA LA LÃNEA DE SINCRONIZACIÃ“N!
            // Ahora la variable 'participantes' estÃ¡ finalizada, sumada y ordenada.
Â  Â  Â  Â  Â  Â  socket.emit('sync_participantes', participantes); // <-- Â¡MOVER AQUÃ!

Â  Â  Â  Â  Â  Â  // Ahora sÃ­, actualiza la UI con la lista ya ordenada
Â  Â  Â  Â  Â  Â  actualizarParticipantesUI();
Â  Â  Â  Â  });
socket.on('id_invalido', (data) => {
    // ğŸ›‘ 1. Establecer la bandera como invÃ¡lida
    isConnectedValid = false; 

    // ğŸ›‘ 2. Detener la lÃ³gica de la subasta/tiempo
    subastaActiva = false;
    clearInterval(intervalo);
    logDonacionesEl.innerHTML += `<p style="color: red;">ğŸ›‘ ERROR: ConexiÃ³n rechazada. ID InvÃ¡lido: ${data.streamerId}</p>`;
    
    // Muestra la alerta (como ya lo tienes)
    alert(`âŒ ERROR: El ID '${data.streamerId}' no estÃ¡ en la lista autorizada. Por favor, comunÃ­cate con el administrador.`);
});
// ğŸ›‘ FIN DEL BLOQUE A AÃ‘ADIR ğŸ›‘
// ===============================
// ğŸ§¹ Limpiar listas cuando el servidor lo indique
// ===============================
socket.on("limpiar_listas_clientes", () => {
    console.log("ğŸ§¹ Recibido comando para limpiar lista local.");
    participantes = [];
    actualizarParticipantesUI();
    subastaActiva = false;
    console.log("CLIENTE: Interruptor APAGADO.");
});

// ===============================
// ğŸ§­ FunciÃ³n para actualizar la UI (debe ir FUERA de socket.on)
// ===============================
function actualizarParticipantesUI() {
    participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));

    const listaDashboard = document.getElementById("listaParticipantes");
    const listaWidget = document.getElementById("listaParticipantes-widget");
    if (listaDashboard) listaDashboard.innerHTML = "";
    if (listaWidget) listaWidget.innerHTML = "";

    participantes.forEach((p, index) => {
        const itemHTML = `
            <li>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>${index + 1}.</span>
                    <img src="${p.avatar_url || 'https://via.placeholder.com/40/000/fff?text=?'}"
                         alt="avatar"
                         style="width:40px; height:40px; border-radius:50%;">
                    <span>${p.usuario}</span>
                </div>
                <div class="coins">${p.cantidad} ğŸ’</div>
            </li>
        `;

        if (listaDashboard && !document.body.classList.contains('widget-mode')) {
            listaDashboard.innerHTML += itemHTML;
        }

        if (listaWidget && document.body.classList.contains('widget-mode')) {
            listaWidget.innerHTML += itemHTML;
        }
    });
}

/* ================================== */
/* ğŸ‘† FIN DEL BLOQUE PARA PEGAR ğŸ‘† */
/* ================================== */
function abrirWidget() {
    window.electronAPI.abrirWidgetVentana("https://tiktok-servidor.onrender.com/?mode=widget");
}

/* ================================================== */
/* ğŸ‘‘ BLOQUE ÃšNICO PARA MOSTRAR GANADOR (Dashboard + Widget) ğŸ‘‘ */
/* ================================================== */
socket.on("anunciar_ganador", (ganador) => {
    if (!ganador || !ganador.usuario) {
        console.log("âš ï¸ No hubo ganador en esta ronda.");
        return;
    }

    const isWidget = document.body.classList.contains('widget-mode');

    if (!isWidget) {
        // ===========================
        // ğŸ–¥ï¸ MOSTRAR EN DASHBOARD
        // ===========================
        console.log("ğŸ¬ Mostrando popup de ganador en el Dashboard:", ganador.usuario);

        const popup = document.getElementById('winner-popup');
        const nameEl = document.getElementById('winner-name');
        const amountEl = document.getElementById('winner-amount');
        const avatarImgEl = document.getElementById('winner-avatar').querySelector('img');
        const contentEl = document.getElementById('winner-content');

        nameEl.textContent = ganador.usuario;
        amountEl.textContent = ganador.cantidad + " ğŸª™";
        avatarImgEl.src = ganador.avatar_url || 'https://via.placeholder.com/100/555/FFFFFF?text=A';

        requestAnimationFrame(() => {
            popup.style.display = 'flex';
            requestAnimationFrame(() => {
                popup.style.opacity = '1';
                contentEl.style.transform = 'scale(1)';
            });
        });

        setTimeout(() => {
            popup.style.opacity = '0';
            contentEl.style.transform = 'scale(0.7)';
            setTimeout(() => {
                popup.style.display = 'none';
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);

    } else {
        // ===========================
        // ğŸ“º MOSTRAR EN WIDGET (TIKTOK STUDIO)
        // ===========================
        console.log("ğŸ‘‘ Mostrando ganador en el widget:", ganador.usuario);

        // 1ï¸âƒ£ Limpiar el ranking
        const rankingList = document.getElementById("listaParticipantes-widget");
        if (rankingList) rankingList.innerHTML = "";
        participantes = [];

        // 2ï¸âƒ£ Crear un banner flotante encima del widget
        const container = document.createElement("div");
        container.id = "widget-winner-popup";
        container.style.position = "fixed";
        container.style.top = "10%";
        container.style.left = "50%";
        container.style.transform = "translateX(-50%)";
        container.style.zIndex = "9999";
        container.style.background = "rgba(0,0,0,0.85)";
        container.style.color = "#fff";
        container.style.padding = "25px 50px";
        container.style.borderRadius = "20px";
        container.style.textAlign = "center";
        container.style.fontSize = "1.6em";
        container.style.backdropFilter = "blur(6px)";
        container.style.boxShadow = "0 0 20px rgba(255, 215, 0, 0.8)";
        container.style.animation = "popIn 0.4s ease";

        container.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <img src="${ganador.avatar_url || 'https://via.placeholder.com/60/000/fff?text=?'}"
                     style="width:60px; height:60px; border-radius:50%; border:3px solid gold;">
                <div>
                    <div style="font-weight:bold; color:#FFD700;">ğŸ† Â¡GANADOR DE LA SUBASTA! ğŸ†</div>
                    <div>${ganador.usuario}</div>
                    <div style="font-size:1.2em;">${ganador.cantidad} ğŸª™</div>
                </div>
            </div>
        `;

        document.body.appendChild(container);

        // 3ï¸âƒ£ Quitar banner despuÃ©s de 10 segundos
        setTimeout(() => {
            container.style.transition = "opacity 0.5s ease";
            container.style.opacity = "0";
            setTimeout(() => {
                container.remove();
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);
    }
});

/* AnimaciÃ³n del popup */
const style = document.createElement("style");
style.innerHTML = `
@keyframes popIn {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}`;
document.head.appendChild(style);
// Widget (Cliente) - RecepciÃ³n de eventos del Dashboard
socket.on("activar_alerta_snipe_visual", () => {
    // Cuando el Dashboard dice que el Snipe comenzÃ³, activamos la bandera visual
    isSnipeModeVisual = true;
});

socket.on('finalizar_subasta', () => {
    // Cuando la subasta termina, la bandera se apaga (ademÃ¡s de la limpieza)
    isSnipeModeVisual = false; 
    
    // Y hacemos la limpieza final del cuerpo para volver a amarillo
    document.body.classList.remove('snipe-alert');
    const subtextElWidget = document.getElementById('subtext-widget');
    if (subtextElWidget) subtextElWidget.textContent = "El sorteo/subasta termina en";
});
    </script>
</body>
</html>

