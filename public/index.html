|<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Subasta en Vivo</title>
    <style>
        /* ESTILOS BASE DEL DASHBOARD (INTACTO) */
        body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; margin:0; padding:0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        h1 { 
    /* Estilo del nuevo logo "SUBASTINI" */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    font-size: 3.5em; /* Tama√±o grande para el t√≠tulo principal */
    font-weight: 900; 
    color: #FFD700; /* Dorado para el impacto */
    margin: 20px 0 5px 0; 
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    display: block; /* Asegura que la l√≠nea sea completa */
    width: 100%;
}
        ul { list-style: none; padding: 0; }
        li { margin: 5px 0; font-size: 18px; }
        .totales { 
    margin-top: 10px; /* Si esta es muy grande, afectar√° a la separaci√≥n */
    font-weight: bold; 
    font-size: 16px; 
}
        h2 { background: rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 5px; display: inline-block; margin-bottom: 10px; font-size: 18px; }
        button { 
    /* Elimina el margin general de 5px para que button-group lo controle */
    padding: 10px 20px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
}   
.control-btn {
    flex-grow: 1; /* Permite que los botones crezcan para llenar el espacio */
    margin: 0 5px; /* Margen horizontal entre botones, 0 vertical */
    padding: 10px 5px; 
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px #00000033;
    transition: background 0.3s;
}
        .start, .align-green { background: #2ecc71; color: white; } /* Verde brillante */
        .stop, .align-red { background: #e74c3c; color: white; } /* Rojo fuerte */
        /* La barra lateral derecha (LogDonaciones) */
/* La barra lateral derecha (LogDonaciones) - ESTILO BASE (VENTANA NORMAL) */
/* --- NUEVOS ESTILOS PARA ALINEACI√ìN Y COLOR --- */
.button-group {
    display: flex;
    justify-content: space-between; /* Espacia los botones dentro del grupo */
    width: 100%;
    margin-top: 15px; /* Espacio entre las filas de botones */
    box-sizing: border-box;
}

.align-orange {
    background: #f39c12; /* Naranja */
    color: white;
}
.align-orange:hover {
    background: #e67e22;
}
#logDonaciones { 
    background: #2c3e50; 
    color: #ccc; 
    width: 300px; /* Ancho m√°s peque√±o para ventana normal */
    height: 90vh; /* Alto para ventana normal */
    overflow-y: auto; 
    margin: 20px 20px 20px 0; 
    padding: 15px; 
    border-radius: 12px; 
    text-align: left; 
    font-family: monospace; 
    box-sizing: border-box;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
#sub-title { /* Nuevo estilo para el subt√≠tulo peque√±o */
    font-size: 1.1em;
    color: #ccc;
    display: block;
    width: 100%;
    margin-bottom: 20px;
    font-weight: normal;
}
        /* CONTENEDORES PRINCIPALES (MODO DASHBOARD: TRES COLUMNAS) (INTACTO) */
       #ganadores, #participantes {
    padding: 15px; 
    border-radius: 12px;
    overflow-y: auto;
    width: 100%; /* Ocupan todo el ancho de #data-panels */
    min-height: 250px; 
    height: 30vh; /* Altura basada en la vista para que quepa */
    margin: 0 0 20px 0; /* Margen solo inferior para apilar */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    box-sizing: border-box;
}
#ganadores { background: #34495e; } /* Azul oscuro elegante */
#participantes { background: #2ecc71; } /* Verde brillante */


/* Controles Group (Centro) */
#controles-group { 
    width: 380px; /* Ancho fijo para alineaci√≥n */
    padding: 0; 
    margin: 20px; 
    display: flex; 
    flex-direction: column;
}
        #ganadores { 
    background: #2c3e50; 
    width: 350px; 
    height: 400px; 
    overflow-y: auto;
    margin: 20px; 
    padding: 20px; 
    border-radius: 10px; 
    display: inline-block; 
    vertical-align: top;
    box-sizing: border-box;
}
        #participantes { 
    background: #27ae60; 
    width: 350px; 
    height: 400px; 
    overflow-y: auto;
    margin: 20px; 
    padding: 20px; 
    border-radius: 10px; 
    display: inline-block; 
    vertical-align: top;
    box-sizing: border-box;
}
        #controles-group { 
    width: 350px; /* Ancho total del grupo para alinearse con Log */
    padding: 0; 
    margin: 20px; 
    display: flex; 
    flex-direction: column;
}
       #controles { 
    background: #9b59b6; /* P√∫rpura */
    width: 100%; 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 20px; 
    box-sizing: border-box;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
#tiempoBox { 
    background: #e67e22; /* Naranja */
    width: 100%; 
    height: 120px; 
    /* Mantener flexbox para centrado */
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
body { 
    font-family: Arial, sans-serif; 
    background: #1e1e2d; /* Fondo azul oscuro/gris */
    color: white; 
    text-align: center; 
    margin:0; 
    padding:0; 
    /* Alineaci√≥n de 3 columnas */
    display: flex; 
    justify-content: center; 
    align-items: flex-start; 
    min-height: 100vh; 
    flex-wrap: wrap; /* Permite que el t√≠tulo ocupe la fila superior */
}
#main-content-wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
    /* ANCHO M√ÅXIMO EXTREMO: Permitir√° que el header-container se estire mucho */
    max-width: 9999px; 
}

/* Contenedor flexible para Ganadores y Participantes (Lado Izquierdo) */
#data-panels {
    display: flex;
    flex-direction: column; /* Apila Ganadores y Participantes */
    width: 380px; /* Ancho fijo para los paneles de la izquierda */
    height: auto;
    margin-left: 20px;
}

        /* WIDGET MODE (ESTILOS FINALES PARA EL OVERLAY) (INTACTO) */
        .widget-mode body { background: transparent; min-height: 0; display: block; overflow: hidden; }
        
        /* OCULTAR TODO LO QUE NO SEA EL WIDGET (INTACTO) */
        .widget-mode #main-dashboard-content { display: none !important; }
        .widget-mode #logDonaciones { display: none !important; } 

        /* ESTILOS DEL CONTENEDOR PRINCIPAL DEL WIDGET (INTACTO) */
        #widget-container {
            display: none; /* Por defecto oculto */
            flex-direction: column;
            width: 360px; /* Ancho fijo para el widget */
            margin: 0 auto;
            background: linear-gradient(180deg, #0a0a0a 0%, #0f1626 100%);
            border-radius: 10px;
            overflow: hidden;
            border: 4px solid #FFD700; /* Borde grueso, color oro */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); /* Brillo dorado opcional */ 
        }

        /* ESTILOS INTERNOS DEL WIDGET (INTACTO) */
        #tiempoBox-widget { background: #1a1a1a; width: 100%; padding: 10px 0; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px 8px 0 0;border-bottom: 2px solid #FFD700; }
        #tiempoRestante-widget { font-size: 2.5em; color: #FFD700; font-weight: bold; text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
        #subtext-widget { font-size: 14px; color: #ccc; margin-top: 5px; }
       .snipe-alert #tiempoRestante-widget {  color: #FF4D4D !important; /* ROJO */ text-shadow: 0 0 15px rgba(255, 77, 77, 1) !important; /* Sombra ROJA m√°s fuerte */}
        .snipe-alert #subtext-widget {  color: #FF4D4D !important; /* ROJO */}


        #participantes-widget { background: #1c2b3e; width: 100%; height: auto; min-height: 200px; padding: 10px; border-radius: 0 0 8px 8px;box-sizing: border-box; }
        #participantes-widget h2, #participantes-widget .totales { display: none; }
        #listaParticipantes-widget { padding: 0; margin: 0; list-style: none; }
        #listaParticipantes-widget li { display: flex; align-items: center; justify-content: space-between; background: #2a3d5e; margin-bottom: 8px; padding: 10px 15px; border-radius: 12px; font-size: 16px; font-weight: bold; border: 2px solid #555; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        #listaParticipantes-widget li .coins { color: #ffd700; font-size: 1.1em; margin-left: 10px; display: flex; align-items: center; }
        /* #listaParticipantes-widget li .coins::before { content: 'ü™ô'; margin-right: 5px; font-size: 0.9em; } */

        /* --- INICIO: ESTILOS CORRECTOS PARA EL RANKING DEL WIDGET --- */
.rank-icon { 
    font-size: 1.2em; 
    color: #FFD700; /* N√∫mero de ranking en color oro */
    margin-right: 10px; 
    min-width: 25px; 
    height: 25px;
    text-align: center; 
    background: #3a4d70; /* Fondo circular azul oscuro */
    border-radius: 50%; /* Esto lo hace un c√≠rculo */
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #FFD700; /* Borde dorado */
    box-sizing: border-box; /* Para que el padding no rompa el tama√±o */
}
.user-info { 
    display: flex; 
    align-items: center; 
    flex-grow: 1; 
    overflow: hidden; 
}
.user-avatar { 
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    overflow: hidden; 
    margin-right: 10px; 
    border: 2px solid #fff; 
}
.user-avatar img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}
.username { 
    color: #ecf0f1; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    max-width: 150px; 
}
/* --- FIN: ESTILOS CORRECTOS --- */
#winner-popup {
    display: none; /* Oculto por defecto */
    position: fixed; /* Overlay que cubre todo */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    z-index: 100;
    /* Usamos flex para centrar el contenido */
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    /* Para la animaci√≥n de entrada/salida */
    opacity: 0;
    transition: opacity 0.5s ease;
}

#winner-content {
    background: linear-gradient(145deg, #1f2a3a, #1a2330);
    border: 4px solid #FFD700; /* Borde Dorado */
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    color: white;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.7); /* Brillo Dorado */
    /* Animaci√≥n "pop" de entrada */
    transform: scale(0.7);
    transition: transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

#winner-content h2 {
    margin: 0;
    font-size: 24px;
    color: #eee;
}

#winner-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid #FFD700;
    margin: 20px auto;
    overflow: hidden;
}
#winner-avatar img { width: 100%; height: 100%; object-fit: cover; }

#winner-name {
    font-size: 48px;
    color: #FFD700;
    margin: 10px 0;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

#winner-content p {
    font-size: 20px;
    color: #ccc;
    margin: 10px 0;
}
#winner-content p span {
    color: #fff;
    font-weight: bold;
}

.felicidades {
    font-size: 28px !important;
    font-weight: bold;
    color: #FFD700 !important;
}
#copy-notification {
    position: absolute;
    top: 50%; /* Se centrar√° verticalmente en el contenedor */
    left: 50%; /* Se centrar√° horizontalmente en el contenedor */
    transform: translate(-50%, -50%); /* Ajuste fino del centrado */
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 16px;
    opacity: 0; /* Por defecto invisible */
    transition: opacity 0.3s ease-in-out;
    pointer-events: none; /* Permite hacer clic a trav√©s de √©l */
    z-index: 1000; /* Asegura que est√© encima de todo */
}

/* Modificaci√≥n necesaria para que la posici√≥n absoluta funcione correctamente en el bot√≥n */
#controles-group {
    /* ... otros estilos ... */
    position: relative; /* CRUCIAL: Necesita un contenedor padre con posici√≥n */
}
#copy-success-popup {
    display: none; /* Oculto por defecto */
    position: fixed; /* Overlay que cubre todo */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    z-index: 101; /* Un poco m√°s alto que el de ganador si ambos pudieran aparecer */
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    opacity: 0;
    transition: opacity 0.5s ease;
}

#copy-success-content {
    background: linear-gradient(145deg, #1f2a3a, #1a2330);
    border: 4px solid #2ecc71; /* Borde verde para indicar √©xito */
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    color: white;
    box-shadow: 0 0 30px rgba(46, 204, 113, 0.7); /* Brillo verde */
    transform: scale(0.7);
    transition: transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    max-width: 600px; /* Para que no sea demasiado ancho */
    width: 90%;
}

#copy-success-content h2 {
    margin: 0;
    font-size: 36px;
    color: #2ecc71; /* Texto verde para √©xito */
}

#copy-success-content p {
    font-size: 18px;
    color: #eee;
    margin: 15px 0;
}
#header-container {
    /* CR√çTICO: Ancho casi total para tocar los bordes laterales */
    width: 98%; 
    /* Eliminamos max-width para que se estire sin l√≠mite */
    /* max-width: 1200px; <--- ELIMINAR ESTA L√çNEA */
    
    background: #2c3e50; 
    border-radius: 15px; 
    padding: 20px 0; 
    /* Ajustamos el margen para que los 2% restantes se vean como un borde muy fino */
    margin: 20px auto 40px auto; 
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
}

/* Ajustes para el h1 y sub-title dentro del nuevo contenedor */
#header-container h1, #header-container #sub-title {
    width: auto; /* Permite que el texto determine su ancho */
    margin-bottom: 5px; /* Espacio entre t√≠tulo y subt√≠tulo */
}

#header-container h1 {
    font-size: 4em; /* Ligeramente m√°s grande en el header-container */
    margin-top: 0;
}
#header-container #sub-title {
    font-size: 1.2em; /* Ligeramente m√°s grande */
    margin-bottom: 0;
}

/* Ajustar el margen superior de los data-panels para que no choquen con el header */
#data-panels {
    margin-top: 0; /* Elimina el margen superior que ten√≠a */
}
@media (min-width: 1400px) {
    
    /* 1. LogDonaciones: M√°s ancho y m√°s corto (Solo en pantalla grande) */
    #logDonaciones {
        width: 400px; /* M√°s ancho para estirarse a la derecha */
        height: 60vh; /* M√°s corto para no ir tan abajo */
    }
    
    /* 2. Header: M√°xima expansi√≥n (Asegurar que se aplique sobre el estilo base) */
    #header-container {
        width: 98%; 
    }
}
/* Nuevo estilo para hacer los totales m√°s peque√±os y moverlos al final del panel */
.totales-mini { 
    font-size: 13px; 
    opacity: 0.8; 
    margin: 0 0; /* Sin margen propio */
}
/* Opcional: Para asegurar que se peguen abajo si la lista est√° vac√≠a */
#participantes { 
    background: #2ecc71; 
    padding: 15px; 
    /* Modifica o a√±ade: */
    padding-bottom: 5px; /* Reducido a 5px para pegarlo m√°s al borde */
    /* El resto de las reglas flex deben permanecer: */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    /* ... otros estilos como border-radius, box-shadow, etc. */
}
/* Fuerza a la lista de participantes a tomar todo el espacio disponible */
#listaParticipantes {
    flex-grow: 1; 
    min-height: 100px; /* Asegura un m√≠nimo de altura si est√° vac√≠a */
    margin-bottom: 10px; 
}

/* 2. Estilo para el contenedor que envuelve los totales (El sub-cuadro) */
#totales-wrapper {
    background: rgba(0, 0, 0, 0.1); /* Fondo muy sutilmente oscuro (casi transparente) */
    
    /* √öltimo ajuste: Borde de 4px, visible y semitransparente */
    border: 4px solid rgba(200, 200, 200, 0.5); 
    
    border-radius: 8px; 
    margin: 10px auto 5px auto; 
    padding: 5px 12px; 
    display: inline-block; /* Crucial para que se ajuste al tama√±o del texto */
}

/* Sombra opcional (como pediste en la duplicaci√≥n) */
#totales-wrapper:hover {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}

/* 3. Estilo para los textos internos de los totales (ahora en el sub-cuadro) */
#totales-wrapper .totales-mini {
    color: white; /* Texto blanco para resaltar */
    font-weight: bold; 
    opacity: 1.0; 
    margin: 2px 0; /* Margen muy peque√±o entre las dos l√≠neas */
    font-size: 13px; /* Mantenemos el tama√±o peque√±o */
}

/* 4. Estilo del Panel de Participantes (Contenedor Padre) */
#participantes {
    text-align: center; /* Crucial para centrar el elemento #totales-wrapper (inline-block) */
    padding-bottom: 15px; /* Deja espacio debajo del cuadro de totales */
    
    /* Las propiedades flex deben estar aqu√≠ (si no lo est√°n en tu CSS base) */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
        </style>
    </head>
    <body>
        
        <div id="main-content-wrapper">
        <div id="header-container">
            <h1 style="width: 100%; text-align: center;">‚ö° SUBASTINI ‚ö°</h1>
            <div id="sub-title" style="width: 100%; text-align: center;">interactive game tiktok by lorotecayt</div>
        </div>
        <div id="data-panels">
                
               <div id="participantes">
    <h2>üë• Participantes (Ronda Actual)</h2>
    <ul id="listaParticipantes"></ul> 

    <div id="totales-wrapper"> 
        <div class="totales totales-mini">Total participantes: <span id="totalParticipantes">0</span></div>
        <div class="totales totales-mini">Diamantes donados: <span id="totalDiamantes">0</span></div>
    </div>
</div>
                
                <div id="ganadores">
            <h2>üèÜ Ganadores de Rondas</h2><ul id="listaGanadores"></ul>
        </div>

    </div>

            <div id="controles-group">
            <div id="controles">
                
                <h2>üéÆ Controles</h2>
                <label for="idUnico">üîë ID √önico (para Widget):</label><br>
                <input type="text" id="idUnico" placeholder="Ej: MiNombreDeUsuario" style="width: 90%; margin-bottom: 15px; padding: 5px;"><br>
                
                <div class="subcuadro">
    
    <label for="tiempo">‚è± Tiempo inicial (segundos):</label><br>
    <input type="number" id="tiempo" value="200" style="width: 90%; margin-bottom: 10px; padding: 5px;"><br>
    
    <label for="tiempoSnipe">Tiempo de snipe (segundos):</label>
    <input type="number" id="tiempoSnipe" value="15" min="0" style="width: 90%; margin-bottom: 15px; padding: 5px;">

    <div class="button-group">
        <button class="control-btn start" onclick="iniciar()">Iniciar</button> 
        <button class="control-btn align-green" onclick="pausar()">Pausar</button>
        <button class="control-btn align-green" onclick="finalizar()">Finalizar</button> 
    </div>

    <div class="button-group">
        <button class="control-btn align-red" onclick="restart()">Restart</button>
        <button class="control-btn align-red" onclick="abrirWidget()">Ver Widget</button>
    </div>

    <div class="button-group">
        <button class="control-btn align-orange" onclick="generarLinkWidget()">üîó Generar Link Widget</button>
        <button class="control-btn align-orange" onclick="simularRegalo()">Simular Regalo</button>
    </div>
    
    <div id="copy-notification"></div>
                    
                </div> </div> <div id="tiempoBox">
                <h2>‚è≥ Tiempo Restante</h2>
                <div id="tiempoRestante" style="font-size: 2.5em;">0</div>
            </div>
            
        </div> <div id="logDonaciones">
        <strong>üìù Historial de Eventos:</strong>
        <div style="font-size:12px; color:red; margin-top:10px;">‚ùå Desconectado de TikFinity Event API</div>
    </div> </div> ```

        <div id="widget-container" style="display:none;">
            
            <div id="tiempoBox-widget">
                <div id="tiempoRestante-widget">00:00</div>
                <div id="subtext-widget">El sorteo/subasta termina en</div>
            </div>
            <div id="participantes-widget">
                <ul id="listaParticipantes-widget"></ul>
            </div>
            
        </div>
        <div id="copy-success-popup" style="display: none;">
        <div id="copy-success-content">
            <h2 id="copy-success-message">‚úÖ ¬°Link Copiado!</h2>
            <p>El enlace ha sido guardado en tu portapapeles.</p>
            <p id="copy-success-url" style="font-size: 1.1em; color: #ccc; word-break: break-all; margin-top: 15px;"></p>
        </div>
    </div>
        <div id="winner-popup" style="display: none;">
        <div id="winner-content">
            <h2>¬°Ganador de la Ronda!</h2>
            <div id="winner-avatar"><img></div>
            <h1 id="winner-name">@username</h1>
            <p>Don√≥ un total de <span id="winner-amount">0</span> üíé</p>
            <p class="felicidades">¬°Felicidades! üèÜ</p>
        </div>
</div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        const socket = io("https://tiktok-servidor.onrender.com"); // tu URL real de Render

        const listaParticipantesEl = document.getElementById('listaParticipantes');
        const listaGanadoresEl = document.getElementById('listaGanadores');
        const tiempoRestanteEl = document.getElementById('tiempoRestante');
        const logDonacionesEl = document.getElementById('logDonaciones');
        
        let tiempoActual = 0;
        let intervalo = null;
        let participantes = [];
        let ganadoresHistorial = [];
        let isPaused = false; // Estado para la funci√≥n pausar
        let snipeActivado = false; // <-- A√ëADE ESTA L√çNEA
        let subastaActiva = false;
        let isSnipeModeVisual = false;
        let isConnectedValid = false;

        // üëá INICIO: A√ëADIDO BLOQUE (PROTECCI√ìN ANTI-DUPLICADOS) üëá
        const processedGiftIds = new Set();
        setInterval(() => {
          processedGiftIds.clear();
          console.log("Limpiando cach√© de IDs de regalos procesados.");
        }, 60000); // Limpia los IDs cada 60 segundos
        // üëÜ FIN: A√ëADIDO BLOQUE üëÜ

        // --- FUNCIONES DE UTILIDAD ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function actualizarParticipantesUI() {
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));
            
            const isWidgetMode = document.body.classList.contains('widget-mode');
            
            // 1. Apuntamos a las listas correctas
            const listaDashboardEl = document.getElementById('listaParticipantes');
            const listaWidgetEl = document.getElementById('listaParticipantes-widget'); 

            // 2. Limpiamos ambas listas
            if (listaDashboardEl) listaDashboardEl.innerHTML = "";
            if (listaWidgetEl) listaWidgetEl.innerHTML = "";
            
            let totalDiamantes = 0;
            const topN = participantes.slice(0, 5); // Tomamos el Top 5 para el widget

            participantes.forEach((p, index) => {
                const liDashboard = document.createElement("li");
                
                // Formato de Dashboard
                liDashboard.textContent = `${p.usuario} - ${p.cantidad} üíé`;
                if (listaDashboardEl) listaDashboardEl.appendChild(liDashboard);

                // Formato de Widget (Solo el Top 5)
                if (index < 5 && listaWidgetEl) {
                    const liWidget = document.createElement("li");
                    const rango = index + 1;
                    
                    const avatarUrl = p.avatar_url || 'https://via.placeholder.com/30/555/FFFFFF?text=A'; 

                    liWidget.innerHTML = `
                        <div class="rank-icon">${rango}</div>
                        <div class="user-info">
                            <div class="user-avatar"><img src="${avatarUrl}" alt="Avatar"></div>
                            <span class="username">${p.usuario}</span>
                        </div>
                        <span class="coins">${p.cantidad} ü™ô</span>
                    `;
                    listaWidgetEl.appendChild(liWidget);
                }
                
                totalDiamantes += p.cantidad;
            });
            
            if (!isWidgetMode) {
                 document.querySelector('#totalParticipantes').textContent = participantes.length;
                 document.querySelector('#totalDiamantes').textContent = totalDiamantes;
            }
        }
        function obtenerGanador() {
    if (participantes.length === 0) return null;
    return participantes.reduce((max, p) => (p.coins > max.coins ? p : max));
}


        function actualizarGanadoresUI() {
            const listaGanadoresEl = document.getElementById('listaGanadores');
            listaGanadoresEl.innerHTML = "";
            ganadoresHistorial.forEach(g => {
                const li = document.createElement('li');
                li.textContent = `üèÜ ${g.usuario} - ${g.cantidad} üíé`;
                listaGanadoresEl.appendChild(li);
            });
        }
        
        // --- L√ìGICA DEL TEMPORIZADOR ---
        function iniciarTimerLogic() {
            let tiempoInput = document.getElementById("tiempo");
            // Solo resetea si el tiempo es 0 o indefinido (inicio)
            if (tiempoActual <= 0) {
                 tiempoActual = parseInt(tiempoInput ? tiempoInput.value : 200); // Usar 200 como default si no hay input
            }


            if (intervalo) clearInterval(intervalo);
            
            intervalo = setInterval(() => {
                if (!isPaused && tiempoActual > 0) {
                    tiempoActual--;
                    const formattedTime = formatTime(tiempoActual);
                    
                    // 1. DASHBOARD EMITE LA HORA AL SERVIDOR (MAESTRO)
                    if (!document.body.classList.contains('widget-mode')) {
                        socket.emit('sync_time', tiempoActual); 
                    }
                    
                    // 2. Actualizamos el display LOCAL del dashboard
                    if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formattedTime;

                } else if (tiempoActual <= 0) {
                     // Solo el dashboard detiene el tiempo
                    if (!document.body.classList.contains('widget-mode')) {
                        terminarTiempo();
                    }
                }
            }, 1000);
        }

        // --- FUNCIONES DE CONTROL ---
        function iniciar() {
    if (!document.body.classList.contains('widget-mode')) { 
        
        // üõë VALIDACI√ìN 1: Verificar si el ID est√° en el input
        const idUnicoEl = document.getElementById('idUnico');
        const streamerIdActual = idUnicoEl ? idUnicoEl.value.trim() : "";
        
        if (!streamerIdActual) {
            alert("‚ö†Ô∏è ERROR: Debes escribir el ID √önico (para Widget) antes de iniciar la subasta.");
            logDonacionesEl.innerHTML += `<p style="color: red;">üõë ERROR: ID √önico no especificado. No se puede iniciar la subasta.</p>`;
            return; // Detiene la funci√≥n aqu√≠
        }
        
        // Llama a la conexi√≥n. La l√≥gica de inicio debe ir DESPU√âS de la conexi√≥n.
        conectarDashboard(); 

        // üõë VALIDACI√ìN 2: CR√çTICA. SOLO INICIAR SI EL ID ES V√ÅLIDO EN EL SERVIDOR
        if (!isConnectedValid) {
            alert("‚ö†Ô∏è ERROR: El ID no ha sido validado por el servidor. Revisa si hay un mensaje de error.");
            return; // Detiene la funci√≥n si el servidor ya marc√≥ el ID como inv√°lido
        }
        
        // --- L√≥gica de inicio (SOLO se ejecuta si isConnectedValid es true) ---
        snipeActivado = false; 
        subastaActiva = true; 
        logDonacionesEl.innerHTML += `<p style="color: yellow;">‚ñ∂Ô∏è Iniciando ronda...</p>`;
        
        // Si el servidor valida el ID y llegamos aqu√≠, entonces enviamos el evento
        socket.emit("iniciar_subasta"); 
        
        isPaused = false; 
        tiempoActual = 0; 
        iniciarTimerLogic(); // Inicia el reloj maestro en el dashboard
    }
}
function conectarDashboard() {
    // 1. Lee √öNICAMENTE el input ID √önico
    const idUnicoEl = document.getElementById('idUnico');
    let streamerIdActual = idUnicoEl ? idUnicoEl.value : "";

    if (!streamerIdActual) {
        alert("ERROR: Debes escribir el ID √önico (para Widget) antes de iniciar la subasta.");
        isConnectedValid = false; // ‚ùå Asegura que sea falso si falta el ID
        return; 
    }
    
    // üÜï A√ëADE ESTA L√çNEA CLAVE üÜï
    // ASUMIMOS que el ID ser√° v√°lido. SOLO el evento 'id_invalido' la pondr√° en 'false'.
    isConnectedValid = true; 

    // 2. Establecer el TikTok User
    let tiktokUserActual = "No Requerido";
    
    // 3. Emitir el evento de conexi√≥n
    socket.emit("join_room", { 
        streamerId: streamerIdActual, 
        tiktokUser: tiktokUserActual 
    }); 
    
    // 4. Actualizar las variables globales
    streamerId = streamerIdActual; 
    tiktokUser = tiktokUserActual; 

    console.log(`DASHBOARD intentando unirse a sala: ${streamerIdActual}`);
}
// ... (despu√©s de la funci√≥n conectarDashboard() )

function mostrarNotificacion(mensaje, exito) {
    const notifEl = document.getElementById('copy-notification');
    notifEl.textContent = mensaje;
    notifEl.style.background = exito ? 'rgba(46, 204, 113, 0.85)' : 'rgba(231, 76, 60, 0.85)'; // Verde para √©xito, Rojo para error
    notifEl.style.opacity = 1;

    // Ocultar la notificaci√≥n despu√©s de 2 segundos
    setTimeout(() => {
        notifEl.style.opacity = 0;
    }, 2000);
}

function generarLinkWidget() {
    const idUnicoEl = document.getElementById('idUnico');
    const streamerId = idUnicoEl ? idUnicoEl.value.trim() : "";

    if (!streamerId) {
        alert("‚ö†Ô∏è ERROR: Debes escribir un ID √önico en el campo de arriba antes de generar el link.");
        return; 
    }

    const baseURL = window.location.origin + window.location.pathname;
    const widgetURL = `${baseURL}?mode=widget&id=${streamerId}`;

    const tempTextarea = document.createElement('textarea');
    tempTextarea.value = widgetURL;
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    tempTextarea.setSelectionRange(0, 99999);

    try {
        const successful = document.execCommand('copy');
        
        if (successful) {
            const popup = document.getElementById('copy-success-popup');
            const messageEl = document.getElementById('copy-success-message');
            // const urlEl = document.getElementById('copy-success-url'); // ELIMINA ESTA DECLARACI√ìN
            
            messageEl.textContent = '‚úÖ ¬°Link Copiado!';
            // urlEl.textContent = widgetURL; // ELIMINA ESTA L√çNEA
            
            popup.style.display = 'flex';
            setTimeout(() => {
                popup.style.opacity = 1;
                document.getElementById('copy-success-content').style.transform = 'scale(1)';
            }, 10);
            
            setTimeout(() => {
                document.getElementById('copy-success-content').style.transform = 'scale(0.7)';
                popup.style.opacity = 0;
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 500);
            }, 1000); // 1 segundo
            
        } else {
            // Fallback si el copiado autom√°tico no funciona
            alert(`‚ö†Ô∏è Error al copiar autom√°ticamente. Por favor, c√≥pialo manualmente:\n\n${widgetURL}`);
        }
        
    } catch (err) {
        alert(`‚ö†Ô∏è Error al intentar copiar el link. Por favor, c√≥pialo manualmente:\n\n${widgetURL}`);
    } finally {
        document.body.removeChild(tempTextarea);
    }
}

// ... (El resto de tus funciones: finalizar(), pausar(), etc.)
        function terminarTiempo() {
    // 1. Esta funci√≥n solo debe correr en el Dashboard (el "Maestro")
    if (!document.body.classList.contains('widget-mode')) { 
        socket.emit("restaurar_widget");

        // 2. Detiene el reloj
        if (intervalo) { 
            clearInterval(intervalo); 
            intervalo = null; 
        }

        // 3. Avisa a todos que el tiempo (y la subasta) se acab√≥
        socket.emit('finalizar_subasta'); // Avisa al servidor que no acepte m√°s regalos
        socket.emit('sync_time', 0); // Env√≠a '0' a los widgets
        tiempoActual = 0; 
        if (document.getElementById('tiempoRestante')) {
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        }

        // 4. Revisa si hay que activar el SNIPE
        // (Nota: cambi√© el default de 15 a 0 para m√°s seguridad)
        const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;

        if (!snipeActivado && tiempoSnipe > 0) {
            // A) A√öN QUEDA EL SNIPE
            snipeActivado = true; // Marcamos que el snipe ya se us√≥
            logDonacionesEl.innerHTML += `<p style="color: yellow;">‚ö° Modo SNIPE activado (${tiempoSnipe}s extra)</p>`;

            // Avisamos a los widgets del nuevo tiempo
            socket.emit("iniciar_snipe_cliente", tiempoSnipe);

            // üõë NUEVA EMISI√ìN: Avisamos a los Widgets que inicien la ALERTA ROJA üõë
            socket.emit("activar_alerta_snipe_visual"); // <--- A√ëADE ESTA L√çNEA

            // Reiniciamos el temporizador local solo con el tiempo de snipe
            tiempoActual = tiempoSnipe;
            iniciarTimerLogic();

        } 
        else {
            // B) NO HAY SNIPE (o el snipe ya termin√≥)
            // ¬°Aqu√≠ es donde ocurre la finalizaci√≥n autom√°tica!

            if (snipeActivado) {
                logDonacionesEl.innerHTML += `<p style="color: red;">‚èπÔ∏è Ronda finalizada autom√°ticamente (post-snipe).</p>`;
            } else {
                logDonacionesEl.innerHTML += `<p style="color: red;">‚èπÔ∏è Ronda finalizada autom√°ticamente (sin snipe).</p>`;
            }

            // --- INICIO DE LA L√ìGICA MOVIDA DESDE 'FINALIZAR' ---
            if (participantes.length > 0) {
                const ganador = participantes[0]; // El primer elemento ya est√° ordenado
                ganadoresHistorial.unshift(ganador); // A√±adir al principio del historial
                logDonacionesEl.innerHTML += `<p style="color: gold;">üèÜ ¬°Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
                actualizarGanadoresUI();
                socket.emit("anunciar_ganador", ganador);
            } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†logDonacionesEl.innerHTML += `<p style="color: gray;">‚ÑπÔ∏è No hubo participantes en esta ronda.</p>`;
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† }
}
} 
        function finalizar() {
    // 1. Esta funci√≥n solo debe correr en el Dashboard (el "Maestro")
    if (!document.body.classList.contains('widget-mode')) {

        // 2. Detener CUALQUIER temporizador que est√© activo
        if (intervalo) { 
            clearInterval(intervalo); 
            intervalo = null; 
        }
        
        // 3. Sincronizar el tiempo a 0 en todos lados
        tiempoActual = 0;
        socket.emit('sync_time', 0); // Env√≠a '0' a los widgets
        if (document.getElementById('tiempoRestante')) {
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        }
        
        // 4. Avisar al servidor que la subasta se detenga INMEDIATAMENTE
        socket.emit('finalizar_subasta'); 

        // 5. Loggear que fue manual
        logDonacionesEl.innerHTML += `<p style="color: red;">‚èπÔ∏è Ronda finalizada manualmente.</p>`;

        // 6. Procesar al ganador (si existe)
        if (participantes.length > 0) {
                        
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad)); // Ordena de mayor a menor (con parseInt)

            const ganador = participantes[0]; // Ahora s√≠, el [0] es el que m√°s don√≥
            ganadoresHistorial.unshift(ganador); 
            logDonacionesEl.innerHTML += `<p style="color: gold;">üèÜ ¬°Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
            actualizarGanadoresUI();
            socket.emit("anunciar_ganador", ganador); // Env√≠a al ganador correcto
        
        } else {
             logDonacionesEl.innerHTML += `<p style="color: gray;">‚ÑπÔ∏è No hubo participantes en esta ronda.</p>`;
        }

        // 7. APAGAR EL INTERRUPTOR Y LIMPIAR (SIEMPRE)
        subastaActiva = false; // <--- LUGAR CORRECTO (Fuera del if/else del ganador)
        participantes = []; 
        actualizarParticipantesUI(); 
        socket.emit("limpiar_listas"); // (Esta es la √∫nica llamada que debe estar)
    }
}
        // --- üëá ¬°AQU√ç EST√Å EL ARREGLO! üëá ---
        // Manda la orden de limpiar SIEMPRE, 
        // sin importar si hubo ganador o no.
        socket.emit("limpiar_listas");
        // --- üëÜ FIN DEL ARREGLO üëÜ ---
          
        function restart() {
    if (!document.body.classList.contains('widget-mode')) { // Solo el dashboard puede reiniciar
        finalizar(); // Finaliza la ronda actual (guarda ganador si hay, limpia lista)
        // Limpia el historial de ganadores tambi√©n
        ganadoresHistorial = [];
        actualizarGanadoresUI();
        
        // üîÅ Resetea variables globales
        snipeActivado = false; // <-- Muy importante para permitir un nuevo snipe en la siguiente subasta
        
        logDonacionesEl.innerHTML = '<strong>üìù Historial de Eventos:</strong><p style="color: cyan;">üîÑ Sistema reiniciado. Listo para una nueva subasta.</p>';
        
        // No emitimos iniciar_subasta aqu√≠, esperamos que el usuario presione Iniciar
        // Pero s√≠ reseteamos el tiempo visual a 0
        if (document.getElementById('tiempoRestante')) 
            document.getElementById('tiempoRestante').textContent = formatTime(0);
        
        socket.emit('sync_time', 0); // Asegurar que widgets muestren 0
    }
}


        function pausar() {
            if (!document.body.classList.contains('widget-mode')) { // Solo el dashboard puede pausar
                isPaused = !isPaused; // Invierte el estado (true/false)
                if (isPaused) {
                    if (intervalo) clearInterval(intervalo); // Detenemos el intervalo local
                    intervalo = null; // Marcar como detenido
                    logDonacionesEl.innerHTML += `<p style="color: orange;">‚è∏Ô∏è Temporizador en pausa.</p>`;
                    // No enviamos nada al servidor, el widget se queda con la √∫ltima hora recibida
                } else {
                    iniciarTimerLogic(); // Reanudamos la l√≥gica (contin√∫a desde tiempoActual)
                    logDonacionesEl.innerHTML += `<p style="color: green;">‚ñ∂Ô∏è Temporizador reanudado.</p>`;
                }
            }
        }
        // üëá A√ëADE ESTA FUNCI√ìN COMPLETA üëá
        function simularRegalo() {
            // Solo el dashboard (maestro) puede simular
            if (document.body.classList.contains('widget-mode')) return;

            // 1. Nombres y montos aleatorios
            const nombres = ["GatitoVeloz", "LoboEstelar", "ZorroGamer", "PandaNinja", "DragonRojo"];
            const randomUser = nombres[Math.floor(Math.random() * nombres.length)] + Math.floor(Math.random() * 500);
            const randomAmount = Math.floor(Math.random() * 100) + 1; // Simular donaci√≥n de 1 a 100
            const giftName = "Simulaci√≥n";

            // 2. Obtener el total anterior (si el usuario ya existe)
            const existente = participantes.find(p => p.usuario === randomUser);
            let nuevoTotal;

            if (existente) {
                nuevoTotal = existente.cantidad + randomAmount; // Sumamos la nueva donaci√≥n al total
            } else {
                nuevoTotal = randomAmount; // Es un usuario nuevo
            }
            
            // 3. Mostrar en el log del dashboard
            logDonacionesEl.innerHTML += `<p style="color: gray;">[SIM] ${randomUser} envi√≥ +${randomAmount}ü™ô (Nuevo Total: ${nuevoTotal})</p>`;
            logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

            // 4. Emitir al servidor el *NUEVO TOTAL*
            // (El servidor lo retransmitir√°, y socket.on("new_gift") lo reemplazar√°)
            socket.emit("nuevo_regalo", {
                usuario: randomUser,
                cantidad: nuevoTotal,
                regalo: giftName,
                // üëá A√ëADE ESTA L√çNEA üëá
                avatar_url: `https://via.placeholder.com/30/555/FFFFFF?text=${randomUser.charAt(0)}`
            });
        }
        // üëÜ FIN DE LA FUNCI√ìN NUEVA üëÜ

        // --- EVENTOS DE SINCRONIZACI√ìN (El Widget recibe la hora) ---
        socket.on('update_time', (time) => {
    
    if (document.body.classList.contains('widget-mode')) {
        
        // ... (Tu l√≥gica existente para subastaActiva) ...

        tiempoActual = time;
        const formattedTime = formatTime(time);
        
        const tiempoElWidget = document.getElementById('tiempoRestante-widget'); 
        const subtextElWidget = document.getElementById('subtext-widget');
        
        if (tiempoElWidget) tiempoElWidget.textContent = formattedTime;
        
        // üõë L√ìGICA DE CAMBIO DE CLASE AHORA USA LA BANDERA üõë
        
        // Si la bandera est√° ACTIVA (solo se activa cuando el tiempo llega a cero por primera vez)
        if (isSnipeModeVisual && time > 0) {
            
            // 1. Activa la clase 'snipe-alert'. ¬°El contador se pone ROJO!
            document.body.classList.add('snipe-alert');
            
            // 2. Cambia el texto del subt√≠tulo a la alerta
            if (subtextElWidget) {
                subtextElWidget.textContent = "Tiempo por delay de live"; 
            }
        
        } else {
            
            // 1. Desactiva la clase (vuelve al AMARILLO original si no est√° en Snipe)
            document.body.classList.remove('snipe-alert');
            
            // 2. Restaura el texto original del subt√≠tulo (si la subasta a√∫n no ha terminado, es el texto por defecto)
            if (subtextElWidget) {
                subtextElWidget.textContent = "El sorteo/subasta termina en"; 
            }
        }
    }
});

        // --- L√ìGICA DE DETECCI√ìN DE WIDGET Y CONEXI√ìN TIKFINITY ---
// ...
const urlParams = new URLSearchParams(window.location.search);
const isWidgetMode = urlParams.get('mode') === 'widget'; // Variable global (ya existe)


// 1. Obtener los valores de los inputs
let streamerId = "ID_POR_DEFECTO"; // ‚¨ÖÔ∏è IMPORTANTE: ESTO DEBE CAMBIAR
let tiktokUser = "USUARIO_POR_DEFECTO"; // ‚¨ÖÔ∏è ESTO DEBE CAMBIAR
const idUnicoEl = document.getElementById('idUnico');
const tiktokUserEl = document.getElementById('tiktokUser');

if (idUnicoEl) {
    streamerId = idUnicoEl.value; // Lee el valor
}
if (tiktokUserEl) {
    tiktokUser = tiktokUserEl.value; // Lee el valor
}
// ...

if (isWidgetMode) {
    // ===============================
    // üèÉ MODO WIDGET (ESCLAVO)
    // ===============================
    document.body.classList.add('widget-mode');
    
    // Si estamos en widget, el streamerId debe venir de la URL
    streamerId = urlParams.get('id'); 
    
    // Ocultamos el dashboard principal y mostramos el contenedor del widget
    document.getElementById('main-dashboard-content').style.display = 'none';
    document.getElementById('widget-container').style.display = 'flex';
    
    if (streamerId) {
        // El Widget se une a la sala
        socket.emit("join_room", { streamerId: streamerId, tiktokUser: "WidgetCliente" }); // El Widget se identifica como tal
        console.log(`WIDGET unido a la sala: ${streamerId} (WidgetCliente)`);
    }

} else {
    // ===============================
    // üñ•Ô∏è MODO DASHBOARD (MAESTRO)
    // ===============================
    document.getElementById('widget-container').style.display = 'none';
    
    if (streamerId) { // Si hay ID √önico ingresado
        // El Dashboard se une a la sala
        console.log(`DASHBOARD unido a la sala: ${streamerId} (${tiktokUser})`);

        // üéÅ CONEXI√ìN CON TIKFINITY EVENT API (SOLO DASHBOARD) <--- TU C√ìDIGO COMIENZA AQU√ç
        // ... (El resto de tu l√≥gica de conexi√≥n a TikFinity) ...
    } else {
        console.error("ID √önico no ingresado. Por favor, complete el campo 'ID √önico (para Widget)'.");
    }
}

             // ===============================
             // üéÅ CONEXI√ìN CON TIKFINITY EVENT API (SOLO DASHBOARD) <--- MOVIDO AQU√ç
             // ===============================
             try {
                 const tiktokWS = new WebSocket("ws://localhost:21213/");

                 tiktokWS.onopen = () => {
                     console.log("‚úÖ Conectado a TikFinity Event API");
                     // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (logDonacionesEl) {
                         logDonacionesEl.innerHTML += `<p style="color: cyan;">‚úÖ Conectado a TikFinity Event API</p>`;
                     }
                 };

                 tiktokWS.onmessage = (event) => {
                     // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (!logDonacionesEl) return; 
                     if (!subastaActiva) {
                        return; // Ignora todo si la subasta no est√° activa
         }

                     try {
                         const msg = JSON.parse(event.data);
                         if (!msg.event) return;

                         switch (msg.event) {
                             case "gift": { // üåü INICIO DE LA CORRECCI√ìN FINAL üåü
                                 const gift = msg.data;
                                 console.log("DATOS COMPLETOS REGALO:", JSON.stringify(gift, null, 2));  

                                 // 1Ô∏è‚É£ ID √öNICO del evento
                                 const giftEventId = gift.msgId;   
                                 if (!giftEventId) {
                                     console.log("Ignorando evento gift sin msgId");
                                     break; // No podemos procesar sin ID de evento
                                 }

                                 // 2Ô∏è‚É£ Ignorar duplicados (por seguridad)
                                 if (processedGiftIds.has(giftEventId)) {
                                     console.log(`Regalo ya procesado: ${giftEventId}`);
                                     break;
                                 }

                                 // 3Ô∏è‚É£ Filtro inteligente:
                                 // - Si tiene repeatEnd: procesamos solo el final
                                 // - Si NO tiene repeatEnd: lo procesamos igual (regalos grandes o √∫nicos)
                                 if (gift.repeatEnd === false) { 
                                 
                                 // üõë Excepci√≥n clave: Si el regalo vale 100 o m√°s, lo procesamos.
                                 if (gift.diamondCount >= 100) {
                                     console.log(`üíé Regalo grande (>=100) detectado: Procesando a pesar de repeatEnd: false.`);
                                 } else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†    console.log(`Ignorando evento intermedio (repeatEnd: false). Esperando el final del combo.`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†    break;
                                 }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†}
                                 
                                 // (Si repeatEnd es 'true' o 'undefined', el c√≥digo contin√∫a)

                                 // 4Ô∏è‚É£ Marcamos el ID como procesado
                                 processedGiftIds.add(giftEventId);

                                 // 5Ô∏è‚É£ Calculamos el total de diamantes correctamente
                                 const totalDiamonds = (gift.diamondCount || 0) * (gift.repeatCount || 1);
                                 
                                 // 5.1 No procesar regalos sin valor (por si acaso)
                                 if (totalDiamonds === 0) {
                                     console.log("Ignorando regalo con 0 diamantes.");
                                     break;
                                 }

                                 // 6Ô∏è‚É£ Mostramos en pantalla y enviamos al servidor
                                 logDonacionesEl.innerHTML += `<p style="color: gold;">üéÅ ${gift.uniqueId} envi√≥ ${gift.giftName} (${totalDiamonds}üíé)</p>`;
                                 
                                 socket.emit("nuevo_regalo", {
    usuario: gift.uniqueId,
    cantidad: totalDiamonds,
    regalo: gift.giftName,
    avatar_url: gift.profilePictureUrl, // ‚¨ÖÔ∏è ¬°AGREGA ESTA COMA!
    streamerId: streamerId // CR√çTICO: ANADE ESTA LINEA
});

                                 break; // ‚úÖ Fin del case
                             }

                             case "chat":
                                 const chat = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: lightgreen;">üí¨ ${chat.uniqueId}: ${chat.comment}</p>`;
                                 break;

                             case "like":
                                 const like = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: pink;">‚ù§Ô∏è ${like.uniqueId} dio like</p>`;
                                 break;

                             case "follow":
                                 const follow = msg.data;
                                 logDonacionesEl.innerHTML += `<p style="color: orange;">‚≠ê ${follow.uniqueId} empez√≥ a seguirte</p>`;
                                 break;
                         }

                         // Mantenemos el log visible siempre abajo
                         logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

                     } catch (e) {
                         console.error("Error al procesar mensaje TikFinity:", e);
                         logDonacionesEl.innerHTML += `<p style="color: red;">‚ö†Ô∏è Error procesando evento TikFinity.</p>`;
                     }
                 };

                 tiktokWS.onclose = () => {
                      // Asegurarse de que logDonacionesEl exista antes de usarlo
                     if (logDonacionesEl) {
                         logDonacionesEl.innerHTML += `<p style="color: red;">‚ùå Desconectado de TikFinity Event API</p>`;
                     }
                 };

             } catch (err) {
                 console.error("Error al conectar con TikFinity:", err);
                  // Asegurarse de que logDonacionesEl exista antes de usarlo
                 if (logDonacionesEl) {
                     logDonacionesEl.innerHTML += `<p style="color: red;">‚ùå Error al conectar con TikFinity.</p>`;
                 }
             }

        // ===============================
// üéÅ ESCUCHAR REGALOS EN TIEMPO REAL DESDE EL SERVIDOR
// (Esto corre en AMBOS: Dashboard y Widget)
// ===============================
socket.on("new_gift", (gift) => {
            console.log("üíé Nuevo regalo recibido del servidor:", gift);

            const existente = participantes.find(p => p.usuario === gift.usuario);
            // Tomamos la cantidad del regalo que nos env√≠an (ej: 1 rosa, 100 leones)
            const cantidadDelRegalo = parseInt(gift.cantidad) || 0; 

            if (existente) {
                // üõë CORRECCI√ìN CR√çTICA: Sumamos la cantidad nueva a la cantidad existente
                existente.cantidad = parseInt(existente.cantidad) + cantidadDelRegalo; 
                existente.avatar_url = gift.avatar_url;
            } else {
                // üí° Es un usuario nuevo
                participantes.push({
                    usuario: gift.usuario,
                    cantidad: cantidadDelRegalo, 
                    regalo: gift.regalo,
                    avatar_url: gift.avatar_url
                });
            }

            // üí° Ordena la lista CADA VEZ que llegue un regalo.
            participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));

            // üõë L√ìGICA DE SNIPE: Reiniciar el contador si la subasta est√° en modo snipe
            if (!document.body.classList.contains('widget-mode') && snipeActivado && cantidadDelRegalo > 0) {
                const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;
                
                // Si el tiempo est√° bajo o en 0 (esperando el final)
                if (tiempoActual <= tiempoSnipe) {
                    tiempoActual = tiempoSnipe;
                    socket.emit('sync_time', tiempoActual); 
                    logDonacionesEl.innerHTML += `<p style="color: red;">‚è∞ SNIPE: Tiempo restablecido a ${tiempoSnipe}s!</p>`;
                }
            }
// üì¢ ¬°AQU√ç VA LA L√çNEA DE SINCRONIZACI√ìN!
            // Ahora la variable 'participantes' est√° finalizada, sumada y ordenada.
¬† ¬† ¬† ¬† ¬† ¬† socket.emit('sync_participantes', participantes); // <-- ¬°MOVER AQU√ç!

¬† ¬† ¬† ¬† ¬† ¬† // Ahora s√≠, actualiza la UI con la lista ya ordenada
¬† ¬† ¬† ¬† ¬† ¬† actualizarParticipantesUI();
¬† ¬† ¬† ¬† });
socket.on('id_invalido', (data) => {
    // üõë 1. Establecer la bandera como inv√°lida
    isConnectedValid = false; 

    // üõë 2. Detener la l√≥gica de la subasta/tiempo
    subastaActiva = false;
    clearInterval(intervalo);
    logDonacionesEl.innerHTML += `<p style="color: red;">üõë ERROR: Conexi√≥n rechazada. ID Inv√°lido: ${data.streamerId}</p>`;
    
    // Muestra la alerta (como ya lo tienes)
    alert(`‚ùå ERROR: El ID '${data.streamerId}' no est√° en la lista autorizada. Por favor, comun√≠cate con el administrador.`);
});
// üõë FIN DEL BLOQUE A A√ëADIR üõë
// ===============================
// üßπ Limpiar listas cuando el servidor lo indique
// ===============================
socket.on("limpiar_listas_clientes", () => {
    console.log("üßπ Recibido comando para limpiar lista local.");
    participantes = [];
    actualizarParticipantesUI();
    subastaActiva = false;
    console.log("CLIENTE: Interruptor APAGADO.");
});

// ===============================
// üß≠ Funci√≥n para actualizar la UI (debe ir FUERA de socket.on)
// ===============================
function actualizarParticipantesUI() {
    participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));

    const listaDashboard = document.getElementById("listaParticipantes");
    const listaWidget = document.getElementById("listaParticipantes-widget");
    if (listaDashboard) listaDashboard.innerHTML = "";
    if (listaWidget) listaWidget.innerHTML = "";

    participantes.forEach((p, index) => {
        const itemHTML = `
            <li>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span>${index + 1}.</span>
                    <img src="${p.avatar_url || 'https://via.placeholder.com/40/000/fff?text=?'}"
                         alt="avatar"
                         style="width:40px; height:40px; border-radius:50%;">
                    <span>${p.usuario}</span>
                </div>
                <div class="coins">${p.cantidad} üíé</div>
            </li>
        `;

        if (listaDashboard && !document.body.classList.contains('widget-mode')) {
            listaDashboard.innerHTML += itemHTML;
        }

        if (listaWidget && document.body.classList.contains('widget-mode')) {
            listaWidget.innerHTML += itemHTML;
        }
    });
}

/* ================================== */
/* üëÜ FIN DEL BLOQUE PARA PEGAR üëÜ */
/* ================================== */
function abrirWidget() {
    window.electronAPI.abrirWidgetVentana("https://tiktok-servidor.onrender.com/?mode=widget");
}

/* ================================================== */
/* üëë BLOQUE √öNICO PARA MOSTRAR GANADOR (Dashboard + Widget) üëë */
/* ================================================== */
socket.on("anunciar_ganador", (ganador) => {
    if (!ganador || !ganador.usuario) {
        console.log("‚ö†Ô∏è No hubo ganador en esta ronda.");
        return;
    }

    const isWidget = document.body.classList.contains('widget-mode');

    if (!isWidget) {
        // ===========================
        // üñ•Ô∏è MOSTRAR EN DASHBOARD
        // ===========================
        console.log("üé¨ Mostrando popup de ganador en el Dashboard:", ganador.usuario);

        const popup = document.getElementById('winner-popup');
        const nameEl = document.getElementById('winner-name');
        const amountEl = document.getElementById('winner-amount');
        const avatarImgEl = document.getElementById('winner-avatar').querySelector('img');
        const contentEl = document.getElementById('winner-content');

        nameEl.textContent = ganador.usuario;
        amountEl.textContent = ganador.cantidad + " ü™ô";
        avatarImgEl.src = ganador.avatar_url || 'https://via.placeholder.com/100/555/FFFFFF?text=A';

        requestAnimationFrame(() => {
            popup.style.display = 'flex';
            requestAnimationFrame(() => {
                popup.style.opacity = '1';
                contentEl.style.transform = 'scale(1)';
            });
        });

        setTimeout(() => {
            popup.style.opacity = '0';
            contentEl.style.transform = 'scale(0.7)';
            setTimeout(() => {
                popup.style.display = 'none';
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);

    } else {
        // ===========================
        // üì∫ MOSTRAR EN WIDGET (TIKTOK STUDIO)
        // ===========================
        console.log("üëë Mostrando ganador en el widget:", ganador.usuario);

        // 1Ô∏è‚É£ Limpiar el ranking
        const rankingList = document.getElementById("listaParticipantes-widget");
        if (rankingList) rankingList.innerHTML = "";
        participantes = [];

        // 2Ô∏è‚É£ Crear un banner flotante encima del widget
        const container = document.createElement("div");
        container.id = "widget-winner-popup";
        container.style.position = "fixed";
        container.style.top = "10%";
        container.style.left = "50%";
        container.style.transform = "translateX(-50%)";
        container.style.zIndex = "9999";
        container.style.background = "rgba(0,0,0,0.85)";
        container.style.color = "#fff";
        container.style.padding = "25px 50px";
        container.style.borderRadius = "20px";
        container.style.textAlign = "center";
        container.style.fontSize = "1.6em";
        container.style.backdropFilter = "blur(6px)";
        container.style.boxShadow = "0 0 20px rgba(255, 215, 0, 0.8)";
        container.style.animation = "popIn 0.4s ease";

        container.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <img src="${ganador.avatar_url || 'https://via.placeholder.com/60/000/fff?text=?'}"
                     style="width:60px; height:60px; border-radius:50%; border:3px solid gold;">
                <div>
                    <div style="font-weight:bold; color:#FFD700;">üèÜ ¬°GANADOR DE LA SUBASTA! üèÜ</div>
                    <div>${ganador.usuario}</div>
                    <div style="font-size:1.2em;">${ganador.cantidad} ü™ô</div>
                </div>
            </div>
        `;

        document.body.appendChild(container);

        // 3Ô∏è‚É£ Quitar banner despu√©s de 10 segundos
        setTimeout(() => {
            container.style.transition = "opacity 0.5s ease";
            container.style.opacity = "0";
            setTimeout(() => {
                container.remove();
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);
    }
});

/* Animaci√≥n del popup */
const style = document.createElement("style");
style.innerHTML = `
@keyframes popIn {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}`;
document.head.appendChild(style);
// üö® L√ìGICA DE INICIALIZACI√ìN (INCLUYE EL WIDGET FIX) üö®
document.addEventListener('DOMContentLoaded', (event) => {
    // 1. Detecci√≥n del modo Widget en la URL (NECESARIO AQU√ç)
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('mode') === 'widget') {
        // MODO WIDGET
        document.body.classList.add('widget-mode');
        
        const widgetContainer = document.getElementById('widget-container');
        if (widgetContainer) {
            widgetContainer.style.display = 'flex'; // Muestra el widget
        }
        
        const dashboard = document.getElementById('main-content-wrapper');
        if (dashboard) {
             dashboard.style.display = 'none'; // Oculta el dashboard
        }

    } else {
        // MODO DASHBOARD (Si no hay ?mode=widget)
        document.body.classList.remove('widget-mode');
        
        const dashboard = document.getElementById('main-content-wrapper');
        if (dashboard) {
            // CR√çTICO: Devuelve el display a 'flex' para mantener el dise√±o
            dashboard.style.display = 'flex'; 
        }
        
        const widgetContainer = document.getElementById('widget-container');
        if (widgetContainer) {
            widgetContainer.style.display = 'none';
        }
    }
    });
// Widget (Cliente) - Recepci√≥n de eventos del Dashboard
socket.on("activar_alerta_snipe_visual", () => {
    // Cuando el Dashboard dice que el Snipe comenz√≥, activamos la bandera visual
    isSnipeModeVisual = true;
});

socket.on('finalizar_subasta', () => {
    // Cuando la subasta termina, la bandera se apaga (adem√°s de la limpieza)
    isSnipeModeVisual = false; 
    
    // Y hacemos la limpieza final del cuerpo para volver a amarillo
    document.body.classList.remove('snipe-alert');
    const subtextElWidget = document.getElementById('subtext-widget');
    if (subtextElWidget) subtextElWidget.textContent = "El sorteo/subasta termina en";
});

    </script>
</body>
</html>

