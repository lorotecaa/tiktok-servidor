<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Subasta en Vivo</title>
    <style>
        /* Estilos base (Solo visibles en la aplicaciÃ³n de Electron) */
        body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; margin:0; padding:0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        
        /* Oculta todo por defecto */
        #main-dashboard-content { display: none; }
        #widget-container { display: none; }

        /* Estilos del Temporizador (Para la prueba simple) */
        .widget-mode #widget-container {
            display: flex !important;
            flex-direction: column;
            width: 300px; /* TamaÃ±o del widget */
            margin: 0;
            padding: 0;
            background: transparent;
            border-radius: 10px;
            overflow: hidden;
        }

        #tiempoBox-widget { 
            background: #008000; 
            width: 100%; 
            padding: 15px 0; 
            box-sizing: border-box;
            border-radius: 10px;
        }
        #tiempoRestante-widget { 
            font-size: 4em; 
            color: #00FF00; 
            font-weight: bold;
        }

    </style>
</head>
<body>
    
    <div id="main-dashboard-content" style="display: flex; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 1200px;">
        <h1>âš¡ Subasta en Vivo âš¡</h1>
        
        <div id="controles-group" style="display: inline-block;">
            <div id="controles">
                <h2>ðŸŽ® Controles</h2>
                <input type="number" id="tiempo" value="10">
                <button class="start" onclick="iniciar()">Iniciar</button>
            </div>
            <div id="tiempoBox"><h2>Tiempo Restante</h2><div id="tiempoRestante">00:00</div></div>
        </div>
    </div> 

    <div id="widget-container">
        <div id="tiempoBox-widget">
            <div id="tiempoRestante-widget">00:00</div>
            <div id="subtext-widget">TIEMPO REMOTO</div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <script>
        const socket = io(); 

        let tiempoActual = 0;
        let intervalo = null;

        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
        
        function updateTimeDisplay(time) {
            const formattedTime = formatTime(time);
            // Actualizamos solo el display del WIDGET y del DASHBOARD
            if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formattedTime;
            if (document.getElementById('tiempoRestante-widget')) document.getElementById('tiempoRestante-widget').textContent = formattedTime;
        }

        // LÃ“GICA PRINCIPAL: El temporizador maestro corre SÃ“LO en la aplicaciÃ³n de Electron
        function iniciarTimerLogic(duration) {
            tiempoActual = duration;

            if (intervalo) clearInterval(intervalo);
            
            intervalo = setInterval(() => {
                if (tiempoActual > 0) {
                    tiempoActual--;
                    
                    // 1. Actualiza ambos displays locales
                    updateTimeDisplay(tiempoActual);
                    
                    // 2. Si es la ventana de control (Electron), envÃ­a la hora al servidor
                    if (!document.body.classList.contains('widget-mode')) {
                        socket.emit('sync_time', tiempoActual); 
                    }
                } else {
                    terminarTiempo();
                }
            }, 1000);
        }

        // --- FUNCIONES DE CONTROL ---
        function iniciar() {
            const duration = parseInt(document.getElementById("tiempo").value);
            if (isNaN(duration) || duration <= 0) return;
            
            socket.emit("iniciar_subasta"); 
            iniciarTimerLogic(duration); // Inicia el temporizador localmente
        }

        function terminarTiempo() {
            if (intervalo) clearInterval(intervalo);
            socket.emit('finalizar_subasta');
            updateTimeDisplay(0);
        }
        
        // --- EVENTOS DE SINCRONIZACIÃ“N (El Widget recibe la hora) ---
        socket.on('sync_time', (time) => {
            // El widget recibe la hora del servidor (que la envÃ­a Electron)
            if (document.body.classList.contains('widget-mode')) {
                updateTimeDisplay(time);
            }
        });

        // --- LÃ“GICA DE DETECCIÃ“N DE MODO WIDGET ---
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'widget') {
            document.body.classList.add('widget-mode');
            
            // OCULTAR Y MOSTRAR ELEMENTOS
            document.getElementById('main-dashboard-content').style.display = 'none';
            document.getElementById('widget-container').style.display = 'flex';
        } else {
            // MOSTRAR EL DASHBOARD EN MODO NORMAL
            document.getElementById('main-dashboard-content').style.display = 'flex';
            document.getElementById('widget-container').style.display = 'none';
        }

    </script>
</body>
</html>