|<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Subasta en Vivo</title>
    <style>
        /* ESTILOS BASE DEL DASHBOARD (INTACTO) */
        body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; margin:0; padding:0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        h1 { 
    /* Estilo del nuevo logo "SUBASTINI" */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    font-size: 3.5em; /* TamaÃ±o grande para el tÃ­tulo principal */
    font-weight: 900; 
    color: #FFD700; /* Dorado para el impacto */
    margin: 20px 0 5px 0; 
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
    display: block; /* Asegura que la lÃ­nea sea completa */
    width: 100%;
}
        ul { list-style: none; padding: 0; }
        li { margin: 5px 0; font-size: 18px; }
        .totales { 
    margin-top: 10px; /* Si esta es muy grande, afectarÃ¡ a la separaciÃ³n */
    font-weight: bold; 
    font-size: 16px; 
}
        h2 { background: rgba(255,255,255,0.15); padding: 4px 8px; border-radius: 5px; display: inline-block; margin-bottom: 10px; font-size: 18px; }
        button { 
    /* Elimina el margin general de 5px para que button-group lo controle */
    padding: 10px 20px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer; 
}   
.control-btn {
    flex-grow: 1; /* Permite que los botones crezcan para llenar el espacio */
    margin: 0 5px; /* Margen horizontal entre botones, 0 vertical */
    padding: 10px 5px; 
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    box-shadow: 0 4px #00000033;
    transition: background 0.3s;
}
        .start, .align-green { background: #2ecc71; color: white; } /* Verde brillante */
        .stop, .align-red { background: #e74c3c; color: white; } /* Rojo fuerte */
        /* La barra lateral derecha (LogDonaciones) */
/* La barra lateral derecha (LogDonaciones) - ESTILO BASE (VENTANA NORMAL) */
/* --- NUEVOS ESTILOS PARA ALINEACIÃ“N Y COLOR --- */
.button-group {
    display: flex;
    justify-content: space-between; /* Espacia los botones dentro del grupo */
    width: 100%;
    margin-top: 15px; /* Espacio entre las filas de botones */
    box-sizing: border-box;
}

.align-orange {
    background: #f39c12; /* Naranja */
    color: white;
}
.align-orange:hover {
    background: #e67e22;
}
#logDonaciones { 
    background: #2c3e50; 
    color: #ccc; 
    width: 300px; /* Ancho mÃ¡s pequeÃ±o para ventana normal */
    height: 90vh; /* Alto para ventana normal */
    overflow-y: auto; 
    margin: 20px 20px 20px 0; 
    padding: 15px; 
    border-radius: 12px; 
    text-align: left; 
    font-family: monospace; 
    box-sizing: border-box;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
#sub-title { /* Nuevo estilo para el subtÃ­tulo pequeÃ±o */
    font-size: 1.1em;
    color: #ccc;
    display: block;
    width: 100%;
    margin-bottom: 20px;
    font-weight: normal;
}
        /* CONTENEDORES PRINCIPALES (MODO DASHBOARD: TRES COLUMNAS) (INTACTO) */
       #ganadores, #participantes {
    padding: 15px; 
    border-radius: 12px;
    overflow-y: auto;
    width: 100%; /* Ocupan todo el ancho de #data-panels */
    min-height: 250px; 
    height: 30vh; /* Altura basada en la vista para que quepa */
    margin: 0 0 20px 0; /* Margen solo inferior para apilar */
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
    box-sizing: border-box;
}
#ganadores { background: #34495e; } /* Azul oscuro elegante */
#participantes { background: #2ecc71; } /* Verde brillante */


/* Controles Group (Centro) */
#controles-group { 
    width: 380px; /* Ancho fijo para alineaciÃ³n */
    padding: 0; 
    margin: 20px; 
    display: flex; 
    flex-direction: column;
}
        #ganadores { 
    background: #2c3e50; 
    width: 350px; 
    height: 400px; 
    overflow-y: auto;
    margin: 20px; 
    padding: 20px; 
    border-radius: 10px; 
    display: inline-block; 
    vertical-align: top;
    box-sizing: border-box;
}
        #participantes { 
    background: #27ae60; 
    width: 350px; 
    height: 400px; 
    overflow-y: auto;
    margin: 20px; 
    padding: 20px; 
    border-radius: 10px; 
    display: inline-block; 
    vertical-align: top;
    box-sizing: border-box;
}
        #controles-group { 
    width: 350px; /* Ancho total del grupo para alinearse con Log */
    padding: 0; 
    margin: 20px; 
    display: flex; 
    flex-direction: column;
}
       #controles { 
    background: #9b59b6; /* PÃºrpura */
    width: 100%; 
    padding: 20px; 
    border-radius: 12px; 
    margin-bottom: 20px; 
    box-sizing: border-box;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
#tiempoBox { 
    background: #e67e22; /* Naranja */
    width: 100%; 
    height: 120px; 
    /* Mantener flexbox para centrado */
    border-radius: 12px; 
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
}
body { 
    font-family: Arial, sans-serif; 
    background: #1e1e2d; /* Fondo azul oscuro/gris */
    color: white; 
    text-align: center; 
    margin:0; 
    padding:0; 
    /* AlineaciÃ³n de 3 columnas */
    display: flex; 
    justify-content: center; 
    align-items: flex-start; 
    min-height: 100vh; 
    flex-wrap: wrap; /* Permite que el tÃ­tulo ocupe la fila superior */
}
#main-content-wrapper {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
    /* ANCHO MÃXIMO EXTREMO: PermitirÃ¡ que el header-container se estire mucho */
    max-width: 9999px; 
}

/* Contenedor flexible para Ganadores y Participantes (Lado Izquierdo) */
#data-panels {
    display: flex;
    flex-direction: column; /* Apila Ganadores y Participantes */
    width: 380px; /* Ancho fijo para los paneles de la izquierda */
    height: auto;
    margin-left: 20px;
}

        /* WIDGET MODE (ESTILOS FINALES PARA EL OVERLAY) (INTACTO) */
        .widget-mode body { background: transparent; min-height: 0; display: block; overflow: hidden; }
        
        /* OCULTAR TODO LO QUE NO SEA EL WIDGET (INTACTO) */
        .widget-mode #logDonaciones { display: none !important; } 

        /* ESTILOS DEL CONTENEDOR PRINCIPAL DEL WIDGET (INTACTO) */
        #widget-container {
            display: none; /* Por defecto oculto */
            flex-direction: column;
            width: 360px; /* Ancho fijo para el widget */
            margin: 0 auto;
            background: linear-gradient(180deg, #0a0a0a 0%, #0f1626 100%);
            border-radius: 10px;
            overflow: hidden;
            border: 4px solid #FFD700; /* Borde grueso, color oro */
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); /* Brillo dorado opcional */ 
        }

        /* ESTILOS INTERNOS DEL WIDGET (INTACTO) */
        #tiempoBox-widget { background: #1a1a1a; width: 100%; padding: 10px 0; box-sizing: border-box; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px 8px 0 0;border-bottom: 2px solid #FFD700; }
        #tiempoRestante-widget { font-size: 2.5em; color: #FFD700; font-weight: bold; text-shadow: 0 0 8px rgba(255, 215, 0, 0.7); }
        #subtext-widget { font-size: 14px; color: #ccc; margin-top: 5px; }
       .snipe-alert #tiempoRestante-widget {  color: #FF4D4D !important; /* ROJO */ text-shadow: 0 0 15px rgba(255, 77, 77, 1) !important; /* Sombra ROJA mÃ¡s fuerte */}
        .snipe-alert #subtext-widget {  color: #FF4D4D !important; /* ROJO */}


        #participantes-widget { background: #1c2b3e; width: 100%; height: auto; min-height: 200px; padding: 10px; border-radius: 0 0 8px 8px;box-sizing: border-box; }
        #participantes-widget h2, #participantes-widget .totales { display: none; }
        #listaParticipantes-widget { padding: 0; margin: 0; list-style: none; }
        #listaParticipantes-widget li { display: flex; align-items: center; justify-content: space-between; background: #2a3d5e; margin-bottom: 8px; padding: 10px 15px; border-radius: 12px; font-size: 16px; font-weight: bold; border: 2px solid #555; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        #listaParticipantes-widget li .coins { color: #ffd700; font-size: 1.1em; margin-left: 10px; display: flex; align-items: center; }
        /* #listaParticipantes-widget li .coins::before { content: 'ğŸª™'; margin-right: 5px; font-size: 0.9em; } */

        /* --- INICIO: ESTILOS CORRECTOS PARA EL RANKING DEL WIDGET --- */
.rank-icon { 
    font-size: 1.2em; 
    color: #FFD700; /* NÃºmero de ranking en color oro */
    margin-right: 10px; 
    min-width: 25px; 
    height: 25px;
    text-align: center; 
    background: #3a4d70; /* Fondo circular azul oscuro */
    border-radius: 50%; /* Esto lo hace un cÃ­rculo */
    padding: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #FFD700; /* Borde dorado */
    box-sizing: border-box; /* Para que el padding no rompa el tamaÃ±o */
}
.user-info { 
    display: flex; 
    align-items: center; 
    flex-grow: 1; 
    overflow: hidden; 
}
.user-avatar { 
    width: 30px; 
    height: 30px; 
    border-radius: 50%; 
    overflow: hidden; 
    margin-right: 10px; 
    border: 2px solid #fff; 
}
.user-avatar img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; 
}
.username { 
    color: #ecf0f1; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    max-width: 150px; 
}
/* --- FIN: ESTILOS CORRECTOS --- */
#winner-popup {
    display: none; /* Oculto por defecto */
    position: fixed; /* Overlay que cubre todo */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    z-index: 100;
    /* Usamos flex para centrar el contenido */
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    /* Para la animaciÃ³n de entrada/salida */
    opacity: 0;
    transition: opacity 0.5s ease;
}

#winner-content {
    background: linear-gradient(145deg, #1f2a3a, #1a2330);
    border: 4px solid #FFD700; /* Borde Dorado */
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    color: white;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.7); /* Brillo Dorado */
    /* AnimaciÃ³n "pop" de entrada */
    transform: scale(0.7);
    transition: transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
}

#winner-content h2 {
    margin: 0;
    font-size: 24px;
    color: #eee;
}

#winner-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid #FFD700;
    margin: 20px auto;
    overflow: hidden;
}
#winner-avatar img { width: 100%; height: 100%; object-fit: cover; }

#winner-name {
    font-size: 48px;
    color: #FFD700;
    margin: 10px 0;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

#winner-content p {
    font-size: 20px;
    color: #ccc;
    margin: 10px 0;
}
#winner-content p span {
    color: #fff;
    font-weight: bold;
}

.felicidades {
    font-size: 28px !important;
    font-weight: bold;
    color: #FFD700 !important;
}
#copy-notification {
    position: absolute;
    top: 50%; /* Se centrarÃ¡ verticalmente en el contenedor */
    left: 50%; /* Se centrarÃ¡ horizontalmente en el contenedor */
    transform: translate(-50%, -50%); /* Ajuste fino del centrado */
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 16px;
    opacity: 0; /* Por defecto invisible */
    transition: opacity 0.3s ease-in-out;
    pointer-events: none; /* Permite hacer clic a travÃ©s de Ã©l */
    z-index: 1000; /* Asegura que estÃ© encima de todo */
}

/* ModificaciÃ³n necesaria para que la posiciÃ³n absoluta funcione correctamente en el botÃ³n */
#controles-group {
    /* ... otros estilos ... */
    position: relative; /* CRUCIAL: Necesita un contenedor padre con posiciÃ³n */
}
#copy-success-popup {
    display: none; /* Oculto por defecto */
    position: fixed; /* Overlay que cubre todo */
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.85); /* Fondo oscuro semitransparente */
    z-index: 101; /* Un poco mÃ¡s alto que el de ganador si ambos pudieran aparecer */
    justify-content: center;
    align-items: center;
    font-family: Arial, sans-serif;
    opacity: 0;
    transition: opacity 0.5s ease;
}

#copy-success-content {
    background: linear-gradient(145deg, #1f2a3a, #1a2330);
    border: 4px solid #2ecc71; /* Borde verde para indicar Ã©xito */
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    color: white;
    box-shadow: 0 0 30px rgba(46, 204, 113, 0.7); /* Brillo verde */
    transform: scale(0.7);
    transition: transform 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    max-width: 600px; /* Para que no sea demasiado ancho */
    width: 90%;
}

#copy-success-content h2 {
    margin: 0;
    font-size: 36px;
    color: #2ecc71; /* Texto verde para Ã©xito */
}

#copy-success-content p {
    font-size: 18px;
    color: #eee;
    margin: 15px 0;
}
#header-container {
    /* CRÃTICO: Ancho casi total para tocar los bordes laterales */
    width: 98%; 
    /* Eliminamos max-width para que se estire sin lÃ­mite */
    /* max-width: 1200px; <--- ELIMINAR ESTA LÃNEA */
    
    background: #2c3e50; 
    border-radius: 15px; 
    padding: 20px 0; 
    /* Ajustamos el margen para que los 2% restantes se vean como un borde muy fino */
    margin: 20px auto 40px auto; 
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6); 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center;
}

/* Ajustes para el h1 y sub-title dentro del nuevo contenedor */
#header-container h1, #header-container #sub-title {
    width: auto; /* Permite que el texto determine su ancho */
    margin-bottom: 5px; /* Espacio entre tÃ­tulo y subtÃ­tulo */
}

#header-container h1 {
    font-size: 4em; /* Ligeramente mÃ¡s grande en el header-container */
    margin-top: 0;
}
#header-container #sub-title {
    font-size: 1.2em; /* Ligeramente mÃ¡s grande */
    margin-bottom: 0;
}

/* Ajustar el margen superior de los data-panels para que no choquen con el header */
#data-panels {
    margin-top: 0; /* Elimina el margen superior que tenÃ­a */
}
@media (min-width: 1400px) {
    
    /* 1. LogDonaciones: MÃ¡s ancho y mÃ¡s corto (Solo en pantalla grande) */
    #logDonaciones {
        width: 400px; /* MÃ¡s ancho para estirarse a la derecha */
        height: 60vh; /* MÃ¡s corto para no ir tan abajo */
    }
    
    /* 2. Header: MÃ¡xima expansiÃ³n (Asegurar que se aplique sobre el estilo base) */
    #header-container {
        width: 98%; 
    }
}
/* Nuevo estilo para hacer los totales mÃ¡s pequeÃ±os y moverlos al final del panel */
.totales-mini { 
    font-size: 13px; 
    opacity: 0.8; 
    margin: 0 0; /* Sin margen propio */
}
/* Opcional: Para asegurar que se peguen abajo si la lista estÃ¡ vacÃ­a */
#participantes { 
    background: #2ecc71; 
    padding: 15px; 
    /* Modifica o aÃ±ade: */
    padding-bottom: 5px; /* Reducido a 5px para pegarlo mÃ¡s al borde */
    /* El resto de las reglas flex deben permanecer: */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    /* ... otros estilos como border-radius, box-shadow, etc. */
}
/* Fuerza a la lista de participantes a tomar todo el espacio disponible */
#listaParticipantes {
    flex-grow: 1; 
    min-height: 100px; /* Asegura un mÃ­nimo de altura si estÃ¡ vacÃ­a */
    margin-bottom: 10px; 
}

/* 2. Estilo para el contenedor que envuelve los totales (El sub-cuadro) */
#totales-wrapper {
    background: rgba(0, 0, 0, 0.1); /* Fondo muy sutilmente oscuro (casi transparente) */
    
    /* Ãšltimo ajuste: Borde de 4px, visible y semitransparente */
    border: 4px solid rgba(200, 200, 200, 0.5); 
    
    border-radius: 8px; 
    margin: 10px auto 5px auto; 
    padding: 5px 12px; 
    display: inline-block; /* Crucial para que se ajuste al tamaÃ±o del texto */
}

/* Sombra opcional (como pediste en la duplicaciÃ³n) */
#totales-wrapper:hover {
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
}

/* 3. Estilo para los textos internos de los totales (ahora en el sub-cuadro) */
#totales-wrapper .totales-mini {
    color: white; /* Texto blanco para resaltar */
    font-weight: bold; 
    opacity: 1.0; 
    margin: 2px 0; /* Margen muy pequeÃ±o entre las dos lÃ­neas */
    font-size: 13px; /* Mantenemos el tamaÃ±o pequeÃ±o */
}

/* 4. Estilo del Panel de Participantes (Contenedor Padre) */
#participantes {
    text-align: center; /* Crucial para centrar el elemento #totales-wrapper (inline-block) */
    padding-bottom: 15px; /* Deja espacio debajo del cuadro de totales */
    
    /* Las propiedades flex deben estar aquÃ­ (si no lo estÃ¡n en tu CSS base) */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}
/* WIDGET MODE (ESTILOS FINALES PARA EL OVERLAY) */
.widget-mode body { background: transparent; min-height: 0; display: block; overflow: hidden; }

/* OCULTAR TODO LO QUE NO SEA EL WIDGET */
/* Oculta la barra lateral de la izquierda (Ganadores y Participantes del Dashboard) */
.widget-mode #data-panels { 
    display: none !important; 
}

/* Oculta el grupo central (Controles, ID Ãšnico, y Tiempo Restante) */
.widget-mode #controles-group { 
    display: none !important; 
} 

/* Oculta el log de donaciones (barra lateral derecha) */
.widget-mode #logDonaciones { 
    display: none !important; 
} 

/* Oculta el encabezado grande (TÃ­tulo SUBSTINI y subtÃ­tulo) si estÃ¡ fuera de los anteriores */
.widget-mode #header-container { 
    display: none !important; 
}
        </style>
    </head>
    <body>
        
        <div id="main-content-wrapper">
        <div id="header-container">
            <h1 style="width: 100%; text-align: center;">âš¡ SUBASTINI âš¡</h1>
            <div id="sub-title" style="width: 100%; text-align: center;">interactive game tiktok by lorotecayt</div>
        </div>
        <div id="data-panels">
                
               <div id="participantes">
    <h2>ğŸ‘¥ Participantes (Ronda Actual)</h2>
    <ul id="listaParticipantes"></ul> 

    <div id="totales-wrapper"> 
        <div class="totales totales-mini">Total participantes: <span id="totalParticipantes">0</span></div>
        <div class="totales totales-mini">Diamantes donados: <span id="totalDiamantes">0</span></div>
    </div>
</div>
                
                <div id="ganadores">
            <h2>ğŸ† Ganadores de Rondas</h2><ul id="listaGanadores"></ul>
        </div>

    </div>

            <div id="controles-group">
            <div id="controles">
                
                <h2>ğŸ® Controles</h2>
                <label for="idUnico">ğŸ”‘ ID Ãšnico (para Widget):</label><br>
                <input type="text" id="idUnico" placeholder="Ej: MiNombreDeUsuario" style="width: 90%; margin-bottom: 15px; padding: 5px;"><br>
                
                <div class="subcuadro">
    
    <label for="tiempo">â± Tiempo inicial (segundos):</label><br>
    <input type="number" id="tiempo" value="200" style="width: 90%; margin-bottom: 10px; padding: 5px;"><br>
    
    <label for="tiempoSnipe">Tiempo de snipe (segundos):</label>
    <input type="number" id="tiempoSnipe" value="15" min="0" style="width: 90%; margin-bottom: 15px; padding: 5px;">

    <div class="button-group">
        <button class="control-btn start" onclick="iniciar()">Iniciar</button> 
        <button class="control-btn align-green" onclick="pausar()">Pausar</button>
        <button class="control-btn align-green" onclick="finalizar()">Finalizar</button> 
    </div>

    <div class="button-group">
        <button class="control-btn align-red" onclick="restart()">Restart</button>
        <button class="control-btn align-red" onclick="abrirWidget()">Ver Widget</button>
    </div>

    <div class="button-group">
        <button class="control-btn align-orange" onclick="generarLinkWidget()">ğŸ”— Generar Link Widget</button>
        <button class="control-btn align-orange" onclick="simularRegalo()">Simular Regalo</button>
    </div>
    
    <div id="copy-notification"></div>
                    
                </div> </div> <div id="tiempoBox">
                <h2>â³ Tiempo Restante</h2>
                <div id="tiempoRestante" style="font-size: 2.5em;">0</div>
            </div>
            
        </div> <div id="logDonaciones">
        <strong>ğŸ“ Historial de Eventos:</strong>
        <div style="font-size:12px; color:red; margin-top:10px;">âŒ Desconectado de TikFinity Event API</div>
    </div> </div> ```

        <div id="widget-container" style="display:none;">
            
            <div id="tiempoBox-widget">
                <div id="tiempoRestante-widget">00:00</div>
                <div id="subtext-widget">El sorteo/subasta termina en</div>
            </div>
            <div id="participantes-widget">
                <ul id="listaParticipantes-widget"></ul>
            </div>
            
        </div>
        <div id="copy-success-popup" style="display: none;">
        <div id="copy-success-content">
            <h2 id="copy-success-message">âœ… Â¡Link Copiado!</h2>
            <p>El enlace ha sido guardado en tu portapapeles.</p>
            <p id="copy-success-url" style="font-size: 1.1em; color: #ccc; word-break: break-all; margin-top: 15px;"></p>
        </div>
    </div>
        <div id="winner-popup" style="display: none;">
        <div id="winner-content">
            <h2>Â¡Ganador de la Ronda!</h2>
            <div id="winner-avatar"><img></div>
            <h1 id="winner-name">@username</h1>
            <p>DonÃ³ un total de <span id="winner-amount">0</span> ğŸ’</p>
            <p class="felicidades">Â¡Felicidades! ğŸ†</p>
        </div>
</div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
Â  Â  
Â  Â  <script>
Â  Â  Â  Â  // ===================================
Â  Â  Â  Â  // 1. DEFINICIONES GLOBALES Y DE MODO
Â  Â  Â  Â  // ===================================
Â  Â  Â  Â  
Â  Â  Â  Â  // --- DEFINICIÃ“N DE MODO (CRÃTICO: Debe ir primero) ---
Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  const isWidgetMode = urlParams.get('mode') === 'widget';
Â  Â  Â  Â  let streamerId = "ID_POR_DEFECTO"; // Se actualizarÃ¡ al conectar
Â  Â  Â  Â  let tiktokUser = "USUARIO_POR_DEFECTO";

Â  Â  Â  Â  // --- ConexiÃ³n al Servidor ---
Â  Â  Â  Â  const socket = io("https://tiktok-servidor.onrender.com");

Â  Â  Â  Â  // --- Selectores de Elementos ---
Â  Â  Â  Â  const listaParticipantesEl = document.getElementById('listaParticipantes');
Â  Â  Â  Â  const listaGanadoresEl = document.getElementById('listaGanadores');
Â  Â  Â  Â  const tiempoRestanteEl = document.getElementById('tiempoRestante');
Â  Â  Â  Â  const logDonacionesEl = document.getElementById('logDonaciones');
Â  Â  Â  Â  
Â  Â  Â  Â  // --- Variables de Estado ---
Â  Â  Â  Â  let tiempoActual = 0;
Â  Â  Â  Â  let intervalo = null;
Â  Â  Â  Â  let participantes = [];
Â  Â  Â  Â  let ganadoresHistorial = [];
Â  Â  Â  Â  let isPaused = false;
Â  Â  Â  Â  let snipeActivado = false;
Â  Â  Â  Â  let subastaActiva = false;
Â  Â  Â  Â  let isSnipeModeVisual = false;
Â  Â  Â  Â  let isConnectedValid = false;
Â  Â  Â  Â  const processedGiftIds = new Set();
Â  Â  Â  Â  
Â  Â  Â  Â  // Limpiador de cachÃ© de regalos
Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  processedGiftIds.clear();
Â  Â  Â  Â  Â  console.log("Limpiando cachÃ© de IDs de regalos procesados.");
Â  Â  Â  Â  }, 60000);

Â  Â  Â  Â  // ===================================
Â  Â  Â  Â  // 2. FUNCIONES DE UTILIDAD Y DIBUJO
Â  Â  Â  Â  // ===================================

Â  Â  Â  Â  function formatTime(totalSeconds) {
Â  Â  Â  Â  Â  Â  const minutes = Math.floor(totalSeconds / 60);
Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;
Â  Â  Â  Â  Â  Â  return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // (FunciÃ³n ÃšNICA y Corregida para dibujar ambas listas)
Â  Â  Â  Â  function actualizarParticipantesUI(listaParaDibujar) {
Â  Â  Â  Â  Â  Â  const listaFinal = listaParaDibujar || participantes; // Usa el argumento o la global
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 1. Apuntamos a las listas correctas
Â  Â  Â  Â  Â  Â  const listaDashboardEl = document.getElementById('listaParticipantes');
Â  Â  Â  Â  Â  Â  const listaWidgetEl = document.getElementById('listaParticipantes-widget'); 

Â  Â  Â  Â  Â  Â  // 2. Limpiamos ambas listas
Â  Â  Â  Â  Â  Â  if (listaDashboardEl) listaDashboardEl.innerHTML = "";
Â  Â  Â  Â  Â  Â  if (listaWidgetEl) listaWidgetEl.innerHTML = "";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let totalDiamantes = 0;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!listaFinal || listaFinal.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isWidgetMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#totalParticipantes').textContent = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#totalDiamantes').textContent = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return; // Salir si no hay nada que dibujar
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  listaFinal.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));

Â  Â  Â  Â  Â  Â  listaFinal.forEach((p, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  const avatarUrl = p.avatar_url || 'https://via.placeholder.com/30/555/FFFFFF?text=A'; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Formato de Dashboard
Â  Â  Â  Â  Â  Â  Â  Â  if (listaDashboardEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const liDashboard = document.createElement("li");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liDashboard.textContent = `${p.usuario} - ${p.cantidad} ğŸ’`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaDashboardEl.appendChild(liDashboard);
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Formato de Widget (Solo el Top 5)
Â  Â  Â  Â  Â  Â  Â  Â  if (index < 5 && listaWidgetEl) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const liWidget = document.createElement("li");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rango = index + 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  liWidget.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="rank-icon">${rango}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="user-avatar"><img src="${avatarUrl}" alt="Avatar"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="username">${p.usuario}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="coins">${p.cantidad} ğŸª™</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  listaWidgetEl.appendChild(liWidget);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  totalDiamantes += p.cantidad;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!isWidgetMode) {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#totalParticipantes').textContent = listaFinal.length;
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector('#totalDiamantes').textContent = totalDiamantes;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function actualizarGanadoresUI() {
Â  Â  Â  Â  Â  Â  const listaGanadoresEl = document.getElementById('listaGanadores');
Â  Â  Â  Â  Â  Â  if (!listaGanadoresEl) return;
Â  Â  Â  Â  Â  Â  listaGanadoresEl.innerHTML = "";
Â  Â  Â  Â  Â  Â  ganadoresHistorial.forEach(g => {
Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = `ğŸ† ${g.usuario} - ${g.cantidad} ğŸ’`;
Â  Â  Â  Â  Â  Â  Â  Â  listaGanadoresEl.appendChild(li);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // (Funciones de visualizaciÃ³n del Widget)
Â  Â  Â  Â  function activarModoSubasta() {
Â  Â  Â  Â  Â  Â  // Esta funciÃ³n ASUME que tu HTML tiene un div con id="splash-screen" para el logo
Â  Â  Â  Â  Â  Â  // y que el #widget-container YA CONTIENE la UI activa (reloj y tabla).
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Por tu HTML, no tienes un "splash-screen", el logo estÃ¡ en #header-container
Â  Â  Â  Â  Â  Â  // y la UI activa estÃ¡ en #widget-container.
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Tu lÃ³gica de ocultar/mostrar ya estÃ¡ en el 'if (isWidgetMode)'
Â  Â  Â  Â  Â  Â  // No necesitamos esta funciÃ³n si el HTML estÃ¡ estructurado como lo enviaste.
Â  Â  Â  Â  Â  Â  console.log("Modo subasta activado (visual).");
Â  Â  Â  Â  }
Â  Â  Â  Â  function desactivarModoSubasta() {
Â  Â  Â  Â  Â  Â  // Esta funciÃ³n tampoco es necesaria si la limpieza resetea el widget.
Â  Â  Â  Â  Â  Â  console.log("Modo subasta desactivado (visual).");
Â  Â  Â  Â  }

Â  Â  Â  Â  // ===================================
Â  Â  Â  Â  // 3. FUNCIONES DE CONTROL (DASHBOARD)
Â  Â  Â  Â  // ===================================

Â  Â  Â  Â  function iniciarTimerLogic() {
Â  Â  Â  Â  Â  Â  let tiempoInput = document.getElementById("tiempo");
Â  Â  Â  Â  Â  Â  if (tiempoActual <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  tiempoActual = parseInt(tiempoInput ? tiempoInput.value : 200);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (intervalo) clearInterval(intervalo);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  intervalo = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isPaused && tiempoActual > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tiempoActual--;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedTime = formatTime(tiempoActual);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isWidgetMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.emit('sync_time', { time: tiempoActual, streamerId: streamerId }); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('tiempoRestante')) document.getElementById('tiempoRestante').textContent = formattedTime;

Â  Â  Â  Â  Â  Â  Â  Â  } else if (tiempoActual <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isWidgetMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  terminarTiempo();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  }

Â  Â  Â  Â  function conectarDashboard() {
Â  Â  Â  Â  Â  Â  const idUnicoEl = document.getElementById('idUnico');
Â  Â  Â  Â  Â  Â  let streamerIdActual = idUnicoEl ? idUnicoEl.value.trim() : "";

Â  Â  Â  Â  Â  Â  if (!streamerIdActual) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("ERROR: Debes escribir el ID Ãšnico (para Widget) antes de iniciar la subasta.");
Â  Â  Â  Â  Â  Â  Â  Â  isConnectedValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  isConnectedValid = true; 
Â  Â  Â  Â  Â  Â  let tiktokUserActual = "No Requerido";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  socket.emit("join_room", { 
Â  Â  Â  Â  Â  Â  Â  Â  streamerId: streamerIdActual, 
Â  Â  Â  Â  Â  Â  Â  Â  tiktokUser: tiktokUserActual 
Â  Â  Â  Â  Â  Â  }); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  streamerId = streamerIdActual; // Actualiza la variable global
Â  Â  Â  Â  Â  Â  tiktokUser = tiktokUserActual; 

Â  Â  Â  Â  Â  Â  console.log(`DASHBOARD intentando unirse a sala: ${streamerIdActual}`);
Â  Â  Â  Â  }

Â  Â  Â  Â  function iniciar() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const idUnicoEl = document.getElementById('idUnico');
Â  Â  Â  Â  Â  Â  const streamerIdActual = idUnicoEl ? idUnicoEl.value.trim() : "";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!streamerIdActual) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("âš ï¸ ERROR: Debes escribir el ID Ãšnico (para Widget) antes de iniciar la subasta.");
Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: red;">ğŸ›‘ ERROR: ID Ãšnico no especificado. No se puede iniciar la subasta.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  conectarDashboard(); 

Â  Â  Â  Â  Â  Â  if (!isConnectedValid) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("âš ï¸ ERROR: El ID no ha sido validado por el servidor. Revisa si hay un mensaje de error.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const tiempoInput = document.getElementById("tiempo");
Â  Â  Â  Â  Â  Â  const tiempoInicial = parseInt(tiempoInput ? tiempoInput.value : 200);

Â  Â  Â  Â  Â  Â  const tiempoSnipeEl = document.getElementById("tiempoSnipe");
Â  Â  Â  Â  Â  Â  const tiempoSnipe = parseInt(tiempoSnipeEl ? tiempoSnipeEl.value : 15);

Â  Â  Â  Â  Â  Â  snipeActivado = false; 
Â  Â  Â  Â  Â  Â  subastaActiva = true; 
Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: yellow;">â–¶ï¸ Iniciando ronda...</p>`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  socket.emit("iniciar_subasta", {
Â  Â  Â  Â  Â  Â  Â  Â  streamerId: streamerIdActual,
Â  Â  Â  Â  Â  Â  Â  Â  initialTime: tiempoInicial,
Â  Â  Â  Â  Â  Â  Â  Â  snipeTime: tiempoSnipe 
Â  Â  Â  Â  Â  Â  }); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  isPaused = false; 
Â  Â  Â  Â  Â  Â  tiempoActual = 0; 
Â  Â  Â  Â  Â  Â  iniciarTimerLogic();
Â  Â  Â  Â  }

Â  Â  Â  Â  function generarLinkWidget() {
Â  Â  Â  Â  Â  Â  const idUnicoEl = document.getElementById('idUnico');
Â  Â  Â  Â  Â  Â  const streamerId = idUnicoEl ? idUnicoEl.value.trim() : "";

Â  Â  Â  Â  Â  Â  if (!streamerId) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("âš ï¸ ERROR: Debes escribir un ID Ãšnico en el campo de arriba antes de generar el link.");
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const baseURL = window.location.origin + window.location.pathname; 
Â  Â  Â  Â  Â  Â  const widgetURL = `${baseURL}?mode=widget&id=${streamerId}`;

Â  Â  Â  Â  Â  Â  // (FunciÃ³n 'abrirWidget' ahora hace esto, pero lo dejamos por si usas ambos botones)
Â  Â  Â  Â  Â  Â  window.open(widgetURL, '_blank'); 

Â  Â  Â  Â  Â  Â  const tempTextarea = document.createElement('textarea');
Â  Â  Â  Â  Â  Â  tempTextarea.value = widgetURL;
Â  Â  Â  Â  Â  Â  document.body.appendChild(tempTextarea);
Â  Â  Â  Â  Â  Â  tempTextarea.select();
Â  Â  Â  Â  Â  Â  tempTextarea.setSelectionRange(0, 99999);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const successful = document.execCommand('copy');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (successful) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const popup = document.getElementById('copy-success-popup');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const messageEl = document.getElementById('copy-success-message');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const urlEl = document.getElementById('copy-success-url');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  messageEl.textContent = 'âœ… Â¡Link Copiado!';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (urlEl) urlEl.textContent = widgetURL; // (Aseguramos que exista)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popup.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popup.style.opacity = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('copy-success-content').style.transform = 'scale(1)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('copy-success-content').style.transform = 'scale(0.7)';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popup.style.opacity = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  popup.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert(`âš ï¸ Error al copiar automÃ¡ticamente. Por favor, cÃ³pialo manualmente:\n\n${widgetURL}`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  alert(`âš ï¸ Error al intentar copiar el link. Por favor, cÃ³pialo manualmente:\n\n${widgetURL}`);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  document.body.removeChild(tempTextarea);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function terminarTiempo() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return;

Â  Â  Â  Â  Â  Â  socket.emit("restaurar_widget"); // (Esta funciÃ³n no existe en el servidor)

Â  Â  Â  Â  Â  Â  if (intervalo) { 
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalo); 
Â  Â  Â  Â  Â  Â  Â  Â  intervalo = null; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  socket.emit('finalizar_subasta', { streamerId: streamerId }); 
Â  Â  Â  Â  Â  Â  socket.emit('sync_time', { time: 0, streamerId: streamerId }); 
Â  Â  Â  Â  Â  Â  tiempoActual = 0; 
Â  Â  Â  Â  Â  Â  if (document.getElementById('tiempoRestante')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tiempoRestante').textContent = formatTime(0);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;

Â  Â  Â  Â  Â  Â  if (!snipeActivado && tiempoSnipe > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  snipeActivado = true;
Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: yellow;">âš¡ Modo SNIPE activado (${tiempoSnipe}s extra)</p>`;

Â  Â  Â  Â  Â  Â  Â  Â  socket.emit("iniciar_snipe_cliente", tiempoSnipe); // (Esta funciÃ³n no existe en el servidor)
Â  Â  Â  Â  Â  Â  Â  Â  socket.emit("activar_alerta_snipe_visual", { streamerId: streamerId }); 

Â  Â  Â  Â  Â  Â  Â  Â  tiempoActual = tiempoSnipe;
Â  Â  Â  Â  Â  Â  Â  Â  iniciarTimerLogic();

Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (snipeActivado) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada automÃ¡ticamente (post-snipe).</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada automÃ¡ticamente (sin snipe).</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (participantes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const ganador = participantes[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ganadoresHistorial.unshift(ganador);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ† Â¡Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actualizarGanadoresUI();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.emit("anunciar_ganador", { ...ganador, streamerId: streamerId });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â logDonacionesEl.innerHTML += `<p style="color: gray;">â„¹ï¸ No hubo participantes en esta ronda.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  subastaActiva = false;

Â  Â  Â  Â  Â  Â  Â  Â  // (La limpieza de 'participantes' y 'actualizarParticipantesUI' se moviÃ³ a 'finalizar')
Â  Â  Â  Â  Â  Â  Â  Â  socket.emit("limpiar_listas", { streamerId: streamerId });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function finalizar() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return;

Â  Â  Â  Â  Â  Â  if (intervalo) { 
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalo); 
Â  Â  Â  Â  Â  Â  Â  Â  intervalo = null; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  tiempoActual = 0;
Â  Â  Â  Â  Â  Â  socket.emit('sync_time', { time: 0, streamerId: streamerId }); 
Â  Â  Â  Â  Â  Â  if (document.getElementById('tiempoRestante')) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tiempoRestante').textContent = formatTime(0);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  socket.emit('finalizar_subasta', { streamerId: streamerId }); 
Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: red;">â¹ï¸ Ronda finalizada manualmente.</p>`;

Â  Â  Â  Â  Â  Â  if (participantes.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  participantes.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad)); 
Â  Â  Â  Â  Â  Â  Â  Â  const ganador = participantes[0];
Â  Â  Â  Â  Â  Â  Â  Â  ganadoresHistorial.unshift(ganador); 
Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ† Â¡Ganador guardado: ${ganador.usuario} con ${ganador.cantidad} diamantes!</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  actualizarGanadoresUI();
Â  Â  Â  Â  Â  Â  Â  Â  socket.emit("anunciar_ganador", { ...ganador, streamerId: streamerId });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â logDonacionesEl.innerHTML += `<p style="color: gray;">â„¹ï¸ No hubo participantes en esta ronda.</p>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  subastaActiva = false;
Â  Â  Â  Â  Â  Â  participantes = []; 
Â  Â  Â  Â  Â  Â  actualizarParticipantesUI(); 
Â  Â  Â  Â  Â  Â  socket.emit("limpiar_listas", { streamerId: streamerId });
Â  Â  Â  Â  }
Â  Â  Â  Â  Â  
Â  Â  Â  Â  function restart() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return;
Â  Â  Â  Â  Â  Â  finalizar(); 
Â  Â  Â  Â  Â  Â  ganadoresHistorial = [];
Â  Â  Â  Â  Â  Â  actualizarGanadoresUI();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  snipeActivado = false; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML = '<strong>ğŸ“ Historial de Eventos:</strong><p style="color: cyan;">ğŸ”„ Sistema reiniciado. Listo para una nueva subasta.</p>';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (document.getElementById('tiempoRestante')) 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('tiempoRestante').textContent = formatTime(0);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  socket.emit('sync_time', { time: 0, streamerId: streamerId });
Â  Â  Â  Â  }

Â  Â  Â  Â  function pausar() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return;
Â  Â  Â  Â  Â  Â  isPaused = !isPaused;
Â  Â  Â  Â  Â  Â  if (isPaused) {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalo) clearInterval(intervalo); 
Â  Â  Â  Â  Â  Â  Â  Â  intervalo = null; 
Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: orange;">â¸ï¸ Temporizador en pausa.</p>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  iniciarTimerLogic(); 
Â  Â  Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: green;">â–¶ï¸ Temporizador reanudado.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function simularRegalo() {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) return;

Â  Â  Â  Â  Â  Â  if (!streamerId) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("No se puede simular regalo, streamerId no estÃ¡ definido.");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const nombres = ["GatitoVeloz", "LoboEstelar", "ZorroGamer", "PandaNinja", "DragonRojo"];
Â  Â  Â  Â  Â  Â  const randomUser = nombres[Math.floor(Math.random() * nombres.length)] + Math.floor(Math.random() * 500);
Â  Â  Â  Â  Â  Â  const randomAmount = Math.floor(Math.random() * 100) + 1; 
_code
Â  Â  Â  Â  Â  Â  const giftName = "SimulaciÃ³n";

Â  Â  Â  Â  Â  Â  logDonacionesEl.innerHTML += `<p style="color: gray;">[SIM] ${randomUser} enviÃ³ +${randomAmount}ğŸª™</p>`;
Â  Â  Â  Â  Â  Â  logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

Â  Â  Â  Â  Â  Â  socket.emit("nuevo_regalo", {
Â  Â  Â  Â  Â  Â  Â  Â  usuario: randomUser,
Â  Â  Â  Â  Â  Â  Â  Â  cantidad: randomAmount, 
Â  Â  Â  Â  Â  Â  Â  Â  regalo: giftName,
Â  Â  Â  Â  Â  Â  Â  Â  avatar_url: `https://via.placeholder.com/30/555/FFFFFF?text=${randomUser.charAt(0)}`,
Â  Â  Â  Â  Â  Â  Â  Â  streamerId: streamerId 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // (Las funciones 'desactivarModoSubasta' y 'activarModoSubasta' estÃ¡n duplicadas,
Â  Â  Â  Â  //  ya que las peguÃ© antes, pero solo debe haber UNA definiciÃ³n de cada una)

Â  Â  Â  Â  // --- EVENTOS DE SINCRONIZACIÃ“N (El Widget recibe la hora) ---
Â  Â  Â  Â  socket.on('update_time', (time) => {
Â  Â  Â  Â  Â  Â  if (isWidgetMode) {
Â  Â  Â  Â  Â  Â  Â  Â  tiempoActual = time;
Â  Â  Â  Â  Â  Â  Â  Â  const formattedTime = formatTime(time);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const tiempoElWidget = document.getElementById('tiempoRestante-widget'); 
Â  Â  Â  Â  Â  Â  Â  Â  const subtextElWidget = document.getElementById('subtext-widget');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (tiempoElWidget) tiempoElWidget.textContent = formattedTime;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (isSnipeModeVisual && time > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.add('snipe-alert');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (subtextElWidget) {
Â  Â  nbsp; Â  Â  Â  Â  Â  Â  Â  Â  subtextElWidget.textContent = "Tiempo por delay de live"; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.body.classList.remove('snipe-alert');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (subtextElWidget) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subtextElWidget.textContent = "El sorteo/subasta termina en"; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

// --- LÃ“GICA DE DETECCIÃ“N DE WIDGET Y CONEXIÃ“N TIKFINITY ---
// ... (Tus variables iniciales de streamerId y tiktokUser) ...

if (isWidgetMode) {
    // ===============================
    // ğŸƒ MODO WIDGET (ESCLAVO)
    // ===============================
    document.body.classList.add('widget-mode');

    // ... (otras lÃ³gicas de URL y streamerId) ...
    
    // Ocultamos el dashboard principal y mostramos el contenedor del widget
    document.getElementById('dashboard-container').style.display = 'none'; 
    document.getElementById('widget-container').style.display = 'flex';
    
    // CRÃTICO: MOSTRAR LA INTERFAZ COMPLETA DEL WIDGET AL CARGAR
    // (Ahora que 'activarModoSubasta' estÃ¡ revisada, esta llamada es correcta)
    activarModoSubasta(); 
    
    if (streamerId) {
        socket.emit("join_room", { streamerId: streamerId, tiktokUser: "WidgetCliente" }); 
        console.log(`WIDGET unido a la sala: ${streamerId} (WidgetCliente)`);
    }



 else {
    // ===============================
    // ğŸ–¥ï¸ MODO DASHBOARD (MAESTRO)
    // ===============================
    document.getElementById('widget-container').style.display = 'none';
    
    // 1. Unirse a la sala y conectar con TikFinity
    if (streamerId) { 
        socket.emit("join_room", { streamerId: streamerId, tiktokUser: tiktokUser }); 
        console.log(`DASHBOARD unido a la sala: ${streamerId} (${tiktokUser})`);

        // ==========================================================
        // ğŸ CONEXIÃ“N CON TIKFINITY EVENT API (SOLO DASHBOARD) 
        // ==========================================================
        try {
            // Asume que 'tiktokWS' y su lÃ³gica (onopen, onmessage, onclose)
            // con el 'switch(msg.event)' estÃ¡n definidos aquÃ­.
            const tiktokWS = new WebSocket("ws://localhost:21213/");

            tiktokWS.onopen = () => {
                console.log("âœ… Conectado a TikFinity Event API");
                if (logDonacionesEl) {
                    logDonacionesEl.innerHTML += `<p style="color: cyan;">âœ… Conectado a TikFinity Event API</p>`;
                }
            };
            
            // ... (Toda tu lÃ³gica de tiktokWS.onmessage, switch, processedGiftIds) ...
            tiktokWS.onmessage = (event) => {
                if (!logDonacionesEl) return; 
                if (!subastaActiva) {
                    return; // Ignora todo si la subasta no estÃ¡ activa
                }

                try {
                    const msg = JSON.parse(event.data);
                    if (!msg.event) return;

                    switch (msg.event) {
                        case "gift": {
                            const gift = msg.data;
                            const giftEventId = gift.msgId; 
                            
                            // LÃ³gica de PrevenciÃ³n de Duplicados (CRÃTICO: SOLUCIÃ“N BUG TIKFINITY)
                            if (!giftEventId || processedGiftIds.has(giftEventId)) {
                                console.log(`Regalo ya procesado o sin ID: ${giftEventId}`);
                                break;
                            }
                            processedGiftIds.add(giftEventId);

                            const totalDiamonds = gift.diamondCount || 0; 
                            if (totalDiamonds === 0) break;
                            
                            logDonacionesEl.innerHTML += `<p style="color: gold;">ğŸ ${gift.uniqueId} enviÃ³ ${gift.giftName} (${totalDiamonds}ğŸ’)</p>`;
                            
                            // Enviamos solo el evento individual al servidor para acumulaciÃ³n centralizada
                            socket.emit("nuevo_regalo", {
                                usuario: gift.uniqueId,
                                cantidad: totalDiamonds,
                                regalo: gift.giftName,
                                avatar_url: gift.profilePictureUrl, 
                                streamerId: streamerId 
                            });
                            break; 
                        }
                        case "chat":
                            const chat = msg.data;
                            logDonacionesEl.innerHTML += `<p style="color: lightgreen;">ğŸ’¬ ${chat.uniqueId}: ${chat.comment}</p>`;
                            break;
                        // ... (Resto de cases: like, follow) ...
                        case "like":
                            const like = msg.data;
                            logDonacionesEl.innerHTML += `<p style="color: pink;">â¤ï¸ ${like.uniqueId} dio like</p>`;
                            break;
                        case "follow":
                            const follow = msg.data;
                            logDonacionesEl.innerHTML += `<p style="color: orange;">â­ ${follow.uniqueId} empezÃ³ a seguirte</p>`;
                            break;
                    }
                    logDonacionesEl.scrollTop = logDonacionesEl.scrollHeight;

                } catch (e) {
                    console.error("Error al procesar mensaje TikFinity:", e);
                    logDonacionesEl.innerHTML += `<p style="color: red;">âš ï¸ Error procesando evento TikFinity.</p>`;
                }
            };

            tiktokWS.onclose = () => {
                if (logDonacionesEl) {
                    logDonacionesEl.innerHTML += `<p style="color: red;">âŒ Desconectado de TikFinity Event API</p>`;
                }
            };
            
            // ... (Toda tu lÃ³gica de tiktokWS.onclose y catch) ...

        } catch (err) {
            console.error("Error al conectar con TikFinity:", err);
            if (logDonacionesEl) {
                logDonacionesEl.innerHTML += `<p style="color: red;">âŒ Error al conectar con TikFinity.</p>`;
            }
        }
    } else {
        console.error("ID Ãšnico no ingresado. Por favor, complete el campo 'ID Ãšnico (para Widget)'.");
}
}

// ===============================
// ğŸ ESCUCHAR REGALOS EN TIEMPO REAL DESDE EL SERVIDOR (CRÃTICO)
// (Esto corre en AMBOS: Dashboard y Widget)
// ===============================
// ğŸ›‘ CORRECCIÃ“N CRÃTICA 1: Usar 'actualizar_participantes' para la lista. 
// El servidor ahora envÃ­a la lista COMPLETA por 'actualizar_participantes'.

socket.on("new_gift", (gift) => {
    // Este evento es solo para efectos visuales (Ej: animaciÃ³n de la donaciÃ³n)
    console.log("ğŸ’ Recibido evento new_gift (Solo para efectos visuales si los tienes):", gift);
    
    // ğŸ›‘ CORRECCIÃ“N CRÃTICA 2: Eliminamos TODA la lÃ³gica de acumulaciÃ³n local.
    // La acumulaciÃ³n SÃ“LO se hace en el servidor para evitar duplicados.
    
    // ğŸ›‘ LÃ“GICA DE SNIPE (Solo Dashboard) ğŸ›‘
    if (!document.body.classList.contains('widget-mode') && snipeActivado && (parseInt(gift.cantidad) > 0)) {
        const tiempoSnipe = parseInt(document.getElementById("tiempoSnipe").value) || 0;
        
        // Si el tiempo estÃ¡ bajo o en 0 (esperando el final)
        if (tiempoActual <= tiempoSnipe) {
            tiempoActual = tiempoSnipe;
            socket.emit('sync_time', { time: tiempoActual, streamerId: streamerId }); 
            logDonacionesEl.innerHTML += `<p style="color: red;">â° SNIPE: Tiempo restablecido a ${tiempoSnipe}s!</p>`;
        }
    }
});


// ===============================
// ğŸ ESCUCHAR ACTUALIZACIONES DESDE EL SERVIDOR (CRÃTICO)
// ===============================

// Maneja la actualizaciÃ³n constante o la respuesta inicial del servidor
socket.on("actualizar_participantes", (participantesRecibidos) => { 
    console.log("ğŸ”¥ Recibida lista de participantes del servidor. Actualizando UI...");
    
    // 1. IMPORTANTE: Reemplazamos la variable global
    window.participantes = participantesRecibidos;
    
    // 2. LLAMADA: Llamamos a la funciÃ³n de dibujo
    actualizarParticipantesUI(participantesRecibidos);
    
    // 3. CRÃTICO: Asegurarse de que el Widget oculte el logo de carga si tiene datos
    if (document.body.classList.contains('widget-mode')) {
        activarModoSubasta(); // Forzamos la visualizaciÃ³n si hay datos de estado
    }
});


// ... (Resto de eventos y funciones sin cambios) ...

// ===============================
// ğŸ§¹ Limpiar listas cuando el servidor lo indique
// ===============================
socket.on("limpiar_listas_clientes", () => {
    console.log("ğŸ§¹ Recibido comando para limpiar lista local.");
    participantes = [];
    actualizarParticipantesUI();
    subastaActiva = false;
    isSnipeModeVisual = false; 
    console.log("CLIENTE: Interruptor APAGADO.");
    
    // âœ… CRÃTICO: Al limpiar la subasta, volvemos a mostrar el logo
    if (document.body.classList.contains('widget-mode')) {
        desactivarModoSubasta(); 
    }
});
socket.on("subasta_iniciada", (data) => {
    // Al recibir esta seÃ±al, activamos la vista activa del widget
    console.log("ğŸš€ Subasta Iniciada recibida. Activando modo Subasta.");
    subastaActiva = true;
    
    // FunciÃ³n que oculta el logo SUBASTINI y muestra el contenido real (tiempo/tablas)
    activarModoSubasta(); 

    // AquÃ­ puedes iniciar o actualizar el reloj del Widget si lo necesita
    // ...
});
// 1. Busca el div que contiene el logo SUBASTINI (o la pantalla de carga)
    const splashScreen = document.getElementById('splash-screen-id'); // Reemplaza con tu ID real
    
    // 2. Busca el div que contiene las tablas y el reloj (la interfaz activa)
    const mainUI = document.getElementById('main-ui-id'); // Reemplaza con tu ID real

    // Si los elementos existen, los manipulamos
    if (splashScreen) {
        // âœ… Oculta la pantalla de carga del logo
        splashScreen.style.display = 'none'; 
    }
    if (mainUI) {
        // âœ… Muestra la interfaz activa (reloj, tabla vacÃ­a)
        mainUI.style.display = 'block'; // O 'flex', dependiendo de tu CSS original
    }
}
socket.on("update_subasta_status", (isActive) => {
    // Este evento se envÃ­a en join_room. Si es 'true', activa la vista.
    if (isActive) {
        console.log("âœ… Estado de subasta TRUE recibido. Activando modo Subasta.");
        activarModoSubasta();
    } else {
        // Si el estado es falso, asegura que se muestre el logo de carga.
        desactivarModoSubasta();
    }
});
socket.on("update_participants", (participantes) => {
    // ESTA FUNCIÃ“N ES CRÃTICA:
    renderizarTablaParticipantes(participantes);
    
    // (Opcional, si tienes lÃ³gica en el cliente)
    // TambiÃ©n podrÃ­as actualizar la variable global de participantes si la usas localmente
    // window.participantes = participantes; 
});
// ===============================
// ğŸ§­ FunciÃ³n para actualizar la UI (debe ir FUERA de socket.on)
// ===============================
// Acepta 'listaParaDibujar' como un argumento
function actualizarParticipantesUI(listaParaDibujar) {
    // Si la funciÃ³n se llama sin argumentos (como en el Dashboard), usa la lista global
    const listaFinal = listaParaDibujar || participantes;
    
    // Si la lista final estÃ¡ vacÃ­a, salimos
    if (!listaFinal || listaFinal.length === 0) {
        if (document.getElementById('listaParticipantes')) document.getElementById('listaParticipantes').innerHTML = "";
        if (document.getElementById('listaParticipantes-widget')) document.getElementById('listaParticipantes-widget').innerHTML = "";
        return;
    }

    // El resto del cÃ³digo usa listaFinal en lugar de 'participantes'
    listaFinal.sort((a, b) => parseInt(b.cantidad) - parseInt(a.cantidad));
    
    const isWidgetMode = document.body.classList.contains('widget-mode');
    
    // 1. Apuntamos a las listas correctas
    const listaDashboardEl = document.getElementById('listaParticipantes');
    const listaWidgetEl = document.getElementById('listaParticipantes-widget'); 

    // 2. Limpiamos ambas listas
    if (listaDashboardEl) listaDashboardEl.innerHTML = "";
    if (listaWidgetEl) listaWidgetEl.innerHTML = "";
    
    let totalDiamantes = 0;

    // AquÃ­ usamos listaFinal
    listaFinal.forEach((p, index) => {
        const liDashboard = document.createElement("li");
        
        // Formato de Dashboard
        liDashboard.textContent = `${p.usuario} - ${p.cantidad} ğŸ’`;
        if (listaDashboardEl) listaDashboardEl.appendChild(liDashboard);

        // Formato de Widget (Solo el Top 5)
        if (index < 5 && listaWidgetEl) {
            const liWidget = document.createElement("li");
            const rango = index + 1;
            
            const avatarUrl = p.avatar_url || 'https://via.placeholder.com/30/555/FFFFFF?text=A'; 

            liWidget.innerHTML = `
                <div class="rank-icon">${rango}</div>
                <div class="user-info">
                    <div class="user-avatar"><img src="${avatarUrl}" alt="Avatar"></div>
                    <span class="username">${p.usuario}</span>
                </div>
                <span class="coins">${p.cantidad} ğŸª™</span>
            `;
            listaWidgetEl.appendChild(liWidget);
        }
        
        totalDiamantes += p.cantidad;
    });
    
    if (!isWidgetMode) {
        document.querySelector('#totalParticipantes').textContent = listaFinal.length;
        document.querySelector('#totalDiamantes').textContent = totalDiamantes;
    }
}
/* ================================== */
/* ğŸ‘† FIN DEL BLOQUE PARA PEGAR ğŸ‘† */
/* ================================== */
function abrirWidget() {
    // 1. Obtener la URL base y el streamerId
    const urlBase = "https://tiktok-servidor.onrender.com/?mode=widget";
    // Asumimos que 'idUnico' es el ID de entrada en el Dashboard
    const streamerIdEl = document.getElementById('idUnico'); 
    const streamerId = streamerIdEl ? streamerIdEl.value : "DEFAULT_ID"; 

    if (!streamerId || streamerId.length === 0 || streamerId === "DEFAULT_ID") {
        alert("Por favor, ingresa el ID Ãšnico para el Widget (en el campo del medio) antes de abrirlo.");
        return;
    }

    const widgetUrl = `${urlBase}&id=${streamerId}`;

    // 2. Intentar usar la API de Electron (si existe)
    if (window.electronAPI && window.electronAPI.abrirWidgetVentana) {
        console.log("Abriendo Widget con Electron API...");
        window.electronAPI.abrirWidgetVentana(widgetUrl);
    } 
    // 3. Si no existe la API de Electron, usar el navegador (SOLUCIÃ“N AL ERROR)
    else {
        console.log("Abriendo Widget en nueva ventana del navegador...");
        // Abre una nueva ventana sin barras de navegaciÃ³n, tamaÃ±o optimizado para Widget
        window.open(widgetUrl, 'WidgetSubastini', 'width=400,height=600,toolbar=no,menubar=no,status=no,resizable=yes');
    }
}

/* ================================================== */
/* ğŸ‘‘ BLOQUE ÃšNICO PARA MOSTRAR GANADOR (Dashboard + Widget) ğŸ‘‘ */
/* ================================================== */
socket.on("anunciar_ganador", (ganador) => {
    if (!ganador || !ganador.usuario) {
        console.log("âš ï¸ No hubo ganador en esta ronda.");
        return;
    }

    const isWidget = document.body.classList.contains('widget-mode');

    if (!isWidget) {
        // ===========================
        // ğŸ–¥ï¸ MOSTRAR EN DASHBOARD
        // ===========================
        console.log("ğŸ¬ Mostrando popup de ganador en el Dashboard:", ganador.usuario);

        const popup = document.getElementById('winner-popup');
        const nameEl = document.getElementById('winner-name');
        const amountEl = document.getElementById('winner-amount');
        const avatarImgEl = document.getElementById('winner-avatar').querySelector('img');
        const contentEl = document.getElementById('winner-content');

        nameEl.textContent = ganador.usuario;
        amountEl.textContent = ganador.cantidad + " ğŸª™";
        avatarImgEl.src = ganador.avatar_url || 'https://via.placeholder.com/100/555/FFFFFF?text=A';

        requestAnimationFrame(() => {
            popup.style.display = 'flex';
            requestAnimationFrame(() => {
                popup.style.opacity = '1';
                contentEl.style.transform = 'scale(1)';
            });
        });

        setTimeout(() => {
            popup.style.opacity = '0';
            contentEl.style.transform = 'scale(0.7)';
            setTimeout(() => {
                popup.style.display = 'none';
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);

    } else {
        // ===========================
        // ğŸ“º MOSTRAR EN WIDGET (TIKTOK STUDIO)
        // ===========================
        console.log("ğŸ‘‘ Mostrando ganador en el widget:", ganador.usuario);

        // 1ï¸âƒ£ Limpiar el ranking
        const rankingList = document.getElementById("listaParticipantes-widget");
        if (rankingList) rankingList.innerHTML = "";
        participantes = [];

        // 2ï¸âƒ£ Crear un banner flotante encima del widget
        const container = document.createElement("div");
        container.id = "widget-winner-popup";
        container.style.position = "fixed";
        container.style.top = "10%";
        container.style.left = "50%";
        container.style.transform = "translateX(-50%)";
        container.style.zIndex = "9999";
        container.style.background = "rgba(0,0,0,0.85)";
        container.style.color = "#fff";
        container.style.padding = "25px 50px";
        container.style.borderRadius = "20px";
        container.style.textAlign = "center";
        container.style.fontSize = "1.6em";
        container.style.backdropFilter = "blur(6px)";
        container.style.boxShadow = "0 0 20px rgba(255, 215, 0, 0.8)";
        container.style.animation = "popIn 0.4s ease";

        container.innerHTML = `
            <div style="display:flex; align-items:center; justify-content:center; gap:15px;">
                <img src="${ganador.avatar_url || 'https://via.placeholder.com/60/000/fff?text=?'}"
                     style="width:60px; height:60px; border-radius:50%; border:3px solid gold;">
                <div>
                    <div style="font-weight:bold; color:#FFD700;">ğŸ† Â¡GANADOR DE LA SUBASTA! ğŸ†</div>
                    <div>${ganador.usuario}</div>
                    <div style="font-size:1.2em;">${ganador.cantidad} ğŸª™</div>
                </div>
            </div>
        `;

        document.body.appendChild(container);

        // 3ï¸âƒ£ Quitar banner despuÃ©s de 10 segundos
        setTimeout(() => {
            container.style.transition = "opacity 0.5s ease";
            container.style.opacity = "0";
            setTimeout(() => {
                container.remove();
                socket.emit("limpiar_listas");
            }, 500);
        }, 10000);
    }
});

/* AnimaciÃ³n del popup */
const style = document.createElement("style");
style.innerHTML = `
@keyframes popIn {
  0% { transform: scale(0.8); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}`;
document.head.appendChild(style);

// Widget (Cliente) - RecepciÃ³n de eventos del Dashboard
socket.on("activar_alerta_snipe_visual", () => {
    // Cuando el Dashboard dice que el Snipe comenzÃ³, activamos la bandera visual
    isSnipeModeVisual = true;
});

socket.on('finalizar_subasta', () => {
    // Cuando la subasta termina, la bandera se apaga (ademÃ¡s de la limpieza)
    isSnipeModeVisual = false; 
    
    // Y hacemos la limpieza final del cuerpo para volver a amarillo
    document.body.classList.remove('snipe-alert');
    const subtextElWidget = document.getElementById('subtext-widget');
    if (subtextElWidget) subtextElWidget.textContent = "El sorteo/subasta termina en";
});
    </script>
</body>
</html>

